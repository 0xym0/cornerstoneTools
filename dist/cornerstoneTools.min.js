/*! cornerstoneTools - v0.6.2 - 2015-06-12 | (c) 2014 Chris Hafey | https://github.com/chafey/cornerstoneTools */
var cornerstoneTools=function(a,b,c){"use strict";function d(c){if(!("mousewheel"===c.originalEvent.type&&0===c.originalEvent.wheelDeltaY||"DOMMouseScroll"===c.originalEvent.type&&1===c.originalEvent.axis)){var d=c.currentTarget,e=b.pageToPixel(d,c.pageX,c.pageY);c=window.event||c;var f=c.wheelDelta||-c.detail||-c.originalEvent.detail,g=Math.max(-1,Math.min(1,f)),h={element:d,viewport:b.getViewport(d),image:b.getEnabledElement(d).image,direction:g,pageX:c.pageX,pageY:c.pageY,imageX:e.x,imageY:e.y};a(d).trigger("CornerstoneToolsMouseWheel",h)}}function e(b){a(b).on(g,d)}function f(b){a(b).unbind(g,d)}void 0===c&&(c={});var g="mousewheel DOMMouseScroll";return c.mouseWheelInput={enable:e,disable:f},c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c,d){"use strict";function e(b){a(b.element).trigger("CornerstoneToolsMouseDownActivate",b)}function f(e){var f=(e.data,e.currentTarget),g={page:c.point.pageToPoint(e),image:b.pageToPixel(f,e.pageX,e.pageY),client:{x:e.clientX,y:e.clientY}},h=d.copyPoints(g),i={event:e,which:e.which,viewport:b.getViewport(f),image:b.getEnabledElement(f).image,element:f,startPoints:g,lastPoints:h,currentPoints:g,deltaPoints:{x:0,y:0}},j=jQuery.Event("CornerstoneToolsMouseDoubleClick",i);a(i.element).trigger(j,i)}function g(f){function g(e){var f={page:c.point.pageToPoint(e),image:b.pageToPixel(i,e.pageX,e.pageY),client:{x:e.clientX,y:e.clientY}},g={page:c.point.subtract(f.page,k.page),image:c.point.subtract(f.image,k.image)},h={which:n,viewport:b.getViewport(i),image:b.getEnabledElement(i).image,element:i,startPoints:j,lastPoints:k,currentPoints:f,deltaPoints:g};return a(l.element).trigger("CornerstoneToolsMouseDrag",h),k=d.copyPoints(f),d.pauseEvent(e)}function h(d){var e={page:c.point.pageToPoint(d),image:b.pageToPixel(i,d.pageX,d.pageY),client:{x:d.clientX,y:d.clientY}},f={page:c.point.subtract(e.page,k.page),image:c.point.subtract(e.image,k.image)},m={event:d,which:n,viewport:b.getViewport(i),image:b.getEnabledElement(i).image,element:i,startPoints:j,lastPoints:k,currentPoints:e,deltaPoints:f},o=jQuery.Event("CornerstoneToolsMouseUp",m);a(l.element).trigger(o,m),a(document).off("mousemove",g),a(document).off("mouseup",h)}var i=(f.data,f.currentTarget),j={page:c.point.pageToPoint(f),image:b.pageToPixel(i,f.pageX,f.pageY),client:{x:f.clientX,y:f.clientY}},k=d.copyPoints(j),l={event:f,which:f.which,viewport:b.getViewport(i),image:b.getEnabledElement(i).image,element:i,startPoints:j,lastPoints:k,currentPoints:j,deltaPoints:{x:0,y:0}},m=jQuery.Event("CornerstoneToolsMouseDown",l);if(a(l.element).trigger(m,l),m.isImmediatePropagationStopped()===!1&&e(l)===!0)return d.pauseEvent(f);var n=f.which;return a(document).on("mousemove",g),a(document).on("mouseup",h),d.pauseEvent(f)}function h(e){var f=(e.data,e.currentTarget),g={page:c.point.pageToPoint(e),image:b.pageToPixel(f,e.pageX,e.pageY)},h=d.copyPoints(g),i=e.which,j={page:c.point.pageToPoint(e),image:b.pageToPixel(f,e.pageX,e.pageY),client:{x:e.clientX,y:e.clientY}},k={page:c.point.subtract(j.page,h.page),image:c.point.subtract(j.image,h.image)},l={which:i,viewport:b.getViewport(f),image:b.getEnabledElement(f).image,element:f,startPoints:g,lastPoints:h,currentPoints:j,deltaPoints:k};a(f).trigger("CornerstoneToolsMouseMove",l),h=d.copyPoints(j)}function i(b){a(b).on("mousedown",g),a(b).on("mousemove",h),a(b).on("dblclick",f)}function j(b){a(b).off("mousedown",g),a(b).off("mousemove",h),a(b).off("dblclick",f)}return void 0===d&&(d={}),d.mouseInput={enable:i,disable:j},d}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(b){var c={},d={activate:function(c,d,e){a(c).off("CornerstoneToolsMouseDownActivate",b);var f={mouseButtonMask:d,options:e};a(c).on("CornerstoneToolsMouseDownActivate",f,b)},disable:function(c){a(c).off("CornerstoneToolsMouseDownActivate",b)},enable:function(c){a(c).off("CornerstoneToolsMouseDownActivate",b)},deactivate:function(c){a(c).off("CornerstoneToolsMouseDownActivate",b)},getConfiguration:function(){return c},setConfiguration:function(a){c=a}};return d}return void 0===c&&(c={}),c.simpleMouseButtonTool=d,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c,d){"use strict";function e(e){function f(b){var c=e.createNewMeasurement(b);d.addToolState(b.element,e.toolType,c),a(b.element).off("CornerstoneToolsMouseMove",h),d.moveHandle(b,c.handles.end,function(){d.anyHandlesOutsideImage(b,c.handles)&&d.removeToolState(b.element,e.toolType,c),a(b.element).on("CornerstoneToolsMouseMove",h)})}function g(a,b){return d.isMouseButtonEnabled(b.which,a.data.mouseButtonMask)?(f(b),!1):void 0}function h(a,c){if(d.toolCoordinates.setCoords(c),0===c.which){var f=d.getToolState(c.element,e.toolType);if(void 0!==f){for(var g=!1,h=0;h<f.data.length;h++){var i=f.data[h];d.handleActivator(i.handles,c.currentPoints.image,c.viewport.scale)===!0&&(g=!0)}g===!0&&b.updateImage(c.element)}}}function i(a,b){for(var d in a.handles){var e=c.point.distanceSquared(a.handles[d],b);if(25>e)return a.handles[d]}}function j(b,c){function f(){d.anyHandlesOutsideImage(c,g.handles)&&d.removeToolState(c.element,e.toolType,g),a(c.element).on("CornerstoneToolsMouseMove",h)}var g;if(d.isMouseButtonEnabled(c.which,b.data.mouseButtonMask)){var j,k=c.startPoints.image,l=d.getToolState(b.currentTarget,e.toolType);if(void 0!==l)for(j=0;j<l.data.length;j++){g=l.data[j];var m=i(g,k);if(void 0!==m)return a(c.element).off("CornerstoneToolsMouseMove",h),d.moveHandle(c,m,f),b.stopImmediatePropagation(),!1}if(void 0!==l&&void 0!==e.pointNearTool)for(j=0;j<l.data.length;j++)if(g=l.data[j],e.pointNearTool(g,k))return a(c.element).off("CornerstoneToolsMouseMove",h),d.moveAllHandles(b,g,l,!0),b.stopImmediatePropagation(),!1}}function k(c){a(c).off("CornerstoneImageRendered",e.onImageRendered),a(c).off("CornerstoneToolsMouseMove",h),a(c).off("CornerstoneToolsMouseDown",j),a(c).off("CornerstoneToolsMouseDownActivate",g),b.updateImage(c)}function l(c){a(c).off("CornerstoneImageRendered",e.onImageRendered),a(c).off("CornerstoneToolsMouseMove",h),a(c).off("CornerstoneToolsMouseDown",j),a(c).off("CornerstoneToolsMouseDownActivate",g),a(c).on("CornerstoneImageRendered",e.onImageRendered),b.updateImage(c)}function m(c,d){var f={mouseButtonMask:d};a(c).off("CornerstoneImageRendered",e.onImageRendered),a(c).off("CornerstoneToolsMouseMove",h),a(c).off("CornerstoneToolsMouseDown",j),a(c).off("CornerstoneToolsMouseDownActivate",g),a(c).on("CornerstoneImageRendered",e.onImageRendered),a(c).on("CornerstoneToolsMouseMove",f,h),a(c).on("CornerstoneToolsMouseDown",f,j),a(c).on("CornerstoneToolsMouseDownActivate",f,g),b.updateImage(c)}function n(c,d){var f={mouseButtonMask:d};a(c).off("CornerstoneImageRendered",e.onImageRendered),a(c).off("CornerstoneToolsMouseMove",h),a(c).off("CornerstoneToolsMouseDown",j),a(c).off("CornerstoneToolsMouseDownActivate",g),a(c).on("CornerstoneImageRendered",e.onImageRendered),a(c).on("CornerstoneToolsMouseMove",f,h),a(c).on("CornerstoneToolsMouseDown",f,j),b.updateImage(c)}function o(){return q}function p(a){q=a}var q={},r={enable:l,disable:k,activate:m,deactivate:n,getConfiguration:o,setConfiguration:p};return r}return void 0===d&&(d={}),d.mouseButtonTool=e,d}($,cornerstone,cornerstoneMath,cornerstoneTools),coordsData,cornerstoneTools=function(a,b,c,d){"use strict";function e(e,f){function g(b){var c=e.createNewMeasurement(b);c&&(d.addToolState(b.element,e.toolType,c),a(b.element).off("CornerstoneToolsMouseMove",i),d.moveHandle(b,c.handles.end,function(){d.anyHandlesOutsideImage(b,c.handles)&&d.removeToolState(b.element,e.toolType,c),a(b.element).on("CornerstoneToolsMouseMove",i)},f))}function h(a,b){return d.isMouseButtonEnabled(b.which,a.data.mouseButtonMask)?(g(b),!1):void 0}function i(a,c){if(d.toolCoordinates.setCoords(c),0===c.which){var f=d.getToolState(c.element,e.toolType);if(void 0!==f){for(var g=!1,h=0;h<f.data.length;h++){var i=f.data[h];d.handleActivator(i.handles,c.currentPoints.image,c.viewport.scale)===!0&&(g=!0)}g===!0&&b.updateImage(c.element)}}}function j(a,b){for(var d in a.handles){var e=c.point.distanceSquared(a.handles[d],b);if(25>e)return a.handles[d]}}function k(b,c){function g(){d.anyHandlesOutsideImage(c,h.handles)&&d.removeToolState(c.element,e.toolType,h),a(c.element).on("CornerstoneToolsMouseMove",i)}var h;if(d.isMouseButtonEnabled(c.which,b.data.mouseButtonMask)){var k,l=c.startPoints.image,m=d.getToolState(b.currentTarget,e.toolType);if(void 0!==m)for(k=0;k<m.data.length;k++){h=m.data[k];var n=j(h,l);if(void 0!==n)return a(c.element).off("CornerstoneToolsMouseMove",i),d.moveHandle(c,n,g,f),b.stopImmediatePropagation(),!1}if(void 0!==m&&void 0!==e.pointInsideRect)for(k=0;k<m.data.length;k++)if(h=m.data[k],e.pointInsideRect(h,l))return a(c.element).off("CornerstoneToolsMouseMove",i),d.moveAllHandles(b,h,m,!1,f),b.stopImmediatePropagation(),!1}}function l(c){a(c).off("CornerstoneImageRendered",e.onImageRendered),a(c).off("CornerstoneToolsMouseMove",i),a(c).off("CornerstoneToolsMouseDown",k),a(c).off("CornerstoneToolsMouseDownActivate",h),b.updateImage(c)}function m(c){a(c).off("CornerstoneImageRendered",e.onImageRendered),a(c).off("CornerstoneToolsMouseMove",i),a(c).off("CornerstoneToolsMouseDown",k),a(c).off("CornerstoneToolsMouseDownActivate",h),a(c).on("CornerstoneImageRendered",e.onImageRendered),b.updateImage(c)}function n(c,d){var f={mouseButtonMask:d};a(c).off("CornerstoneImageRendered",e.onImageRendered),a(c).off("CornerstoneToolsMouseMove",i),a(c).off("CornerstoneToolsMouseDown",k),a(c).off("CornerstoneToolsMouseDownActivate",h),a(c).on("CornerstoneImageRendered",e.onImageRendered),a(c).on("CornerstoneToolsMouseMove",f,i),a(c).on("CornerstoneToolsMouseDown",f,k),a(c).on("CornerstoneToolsMouseDownActivate",f,h),b.updateImage(c)}function o(c,d){var f={mouseButtonMask:d};a(c).off("CornerstoneImageRendered",e.onImageRendered),a(c).off("CornerstoneToolsMouseMove",i),a(c).off("CornerstoneToolsMouseDown",k),a(c).off("CornerstoneToolsMouseDownActivate",h),a(c).on("CornerstoneImageRendered",e.onImageRendered),a(c).on("CornerstoneToolsMouseMove",f,i),a(c).on("CornerstoneToolsMouseDown",f,k),b.updateImage(c)}var p={enable:m,disable:l,activate:n,deactivate:o};return p}return void 0===d&&(d={}),d.mouseButtonRectangleTool=e,d}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(b){var c={activate:function(c){a(c).off("CornerstoneToolsMouseWheel",b);var d={};a(c).on("CornerstoneToolsMouseWheel",d,b)},disable:function(c){a(c).off("CornerstoneToolsMouseWheel",b)},enable:function(c){a(c).off("CornerstoneToolsMouseWheel",b)},deactivate:function(c){a(c).off("CornerstoneToolsMouseWheel",b)}};return c}return void 0===c&&(c={}),c.mouseWheelTool=d,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(b){var c={activate:function(c){a(c).off("CornerstoneToolsTouchDrag",b);var d={};a(c).on("CornerstoneToolsTouchDrag",d,b)},disable:function(c){a(c).off("CornerstoneToolsTouchDrag",b)},enable:function(c){a(c).off("CornerstoneToolsTouchDrag",b)},deactivate:function(c){a(c).off("CornerstoneToolsTouchDrag",b)}};return c}return void 0===c&&(c={}),c.touchDragTool=d,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(b){var c={activate:function(c){a(c).off("CornerstoneToolsTouchPinch",b);var d={};a(c).on("CornerstoneToolsTouchPinch",d,b)},disable:function(c){a(c).off("CornerstoneToolsTouchPinch",b)},enable:function(c){a(c).off("CornerstoneToolsTouchPinch",b)},deactivate:function(c){a(c).off("CornerstoneToolsTouchPinch",b)}};return c}return void 0===c&&(c={}),c.touchPinchTool=d,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c,d){"use strict";function e(e){function f(b){var c=e.createNewMeasurement(b);d.addToolState(b.element,e.toolType,c),a(b.element).off("CornerstoneToolsTouchDrag",h),d.touchmoveHandle(b,c.handles.end,function(){d.anyHandlesOutsideImage(b,c.handles)&&d.removeToolState(mouseEventData.element,mouseToolInterface.toolType,c),a(b.element).on("CornerstoneToolsTouchDrag",h)})}function g(a,b){return f(b),!1}function h(a,c){d.toolCoordinates.setCoords(c);var f=d.getToolState(c.element,e.toolType);if(void 0!==f){for(var g=!1,h=0;h<f.data.length;h++){var i=f.data[h];d.handleActivator(i.handles,c.currentPoints.image,c.viewport.scale)===!0&&(g=!0)}g===!0&&b.updateImage(c.element)}}function i(a,b){for(var d in a.handles){var e=c.point.distanceSquared(a.handles[d],b);if(30>e)return a.handles[d]}}function j(b,c){function f(){d.anyHandlesOutsideImage(c,g.handles)&&d.removeToolState(c.element,e.toolType,g),a(c.element).on("CornerstoneToolsTouchDrag",h)}var g,j,k=c.startPoints.image,l=d.getToolState(b.currentTarget,e.toolType);if(void 0!==l)for(j=0;j<l.data.length;j++){g=l.data[j];var m=i(g,k);if(void 0!==m)return a(c.element).off("CornerstoneToolsTouchDrag",h),d.touchmoveHandle(c,m,f),b.stopImmediatePropagation(),!1}if(void 0!==l&&void 0!==e.pointNearTool)for(j=0;j<l.data.length;j++)if(g=l.data[j],e.pointNearTool(g,k))return a(c.element).off("CornerstoneToolsTouchDrag",h),d.touchmoveAllHandles(b,g,l,!0),b.stopImmediatePropagation(),!1}function k(c){a(c).off("CornerstoneImageRendered",e.onImageRendered),a(c).off("CornerstoneToolsTouchDrag",h),a(c).off("CornerstoneToolsDragStart",j),a(c).off("CornerstoneToolsDragStartActive",g),b.updateImage(c)}function l(c){a(c).off("CornerstoneImageRendered",e.onImageRendered),a(c).off("CornerstoneToolsTouchDrag",h),a(c).off("CornerstoneToolsDragStart",j),a(c).off("CornerstoneToolsDragStartActive",g),a(c).on("CornerstoneImageRendered",e.onImageRendered),b.updateImage(c)}function m(c){a(c).off("CornerstoneImageRendered",e.onImageRendered),a(c).off("CornerstoneToolsTouchDrag",h),a(c).off("CornerstoneToolsDragStart",j),a(c).off("CornerstoneToolsDragStartActive",g),a(c).on("CornerstoneImageRendered",e.onImageRendered),a(c).on("CornerstoneToolsTouchDrag",h),a(c).on("CornerstoneToolsDragStart",j),a(c).on("CornerstoneToolsDragStartActive",g),b.updateImage(c)}function n(c){a(c).off("CornerstoneImageRendered",e.onImageRendered),a(c).off("CornerstoneToolsTouchDrag",h),a(c).off("CornerstoneToolsDragStart",j),a(c).off("CornerstoneToolsDragStartActive",g),a(c).on("CornerstoneImageRendered",e.onImageRendered),a(c).on("CornerstoneToolsTouchDrag",h),a(c).on("CornerstoneToolsDragStart",j),b.updateImage(c)}var o={enable:l,disable:k,activate:m,deactivate:n};return o}return void 0===d&&(d={}),d.touchTool=e,d}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(a,b,c,d){"use strict";function e(a){var b={visible:!0,handles:{start:{x:a.currentPoints.image.x-20,y:a.currentPoints.image.y+10,highlight:!0,active:!1},end:{x:a.currentPoints.image.x,y:a.currentPoints.image.y,highlight:!0,active:!0},start2:{x:a.currentPoints.image.x-20,y:a.currentPoints.image.y+10,highlight:!0,active:!1},end2:{x:a.currentPoints.image.x,y:a.currentPoints.image.y+20,highlight:!0,active:!1}}};return b}function f(a,b){var d={start:a.handles.start,end:a.handles.end},e=c.lineSegment.distanceToPoint(d,b);return 5>e?!0:(d.start=a.handles.start2,d.end=a.handles.end2,e=c.lineSegment.distanceToPoint(d,b),5>e)}function g(a,c){var e=d.getToolState(a.currentTarget,h);if(void 0!==e){var g=c.canvasContext.canvas.getContext("2d");b.setToPixelCoordinateSystem(c.enabledElement,g);for(var i,j=0;j<e.data.length;j++){g.save();var k=e.data[j];f(k,d.toolCoordinates.getCoords())?(k.active=!0,i=d.toolColors.getActiveColor()):(k.active=!1,i=d.toolColors.getToolColor()),g.beginPath(),g.strokeStyle=i,g.lineWidth=1/c.viewport.scale,g.moveTo(k.handles.start.x,k.handles.start.y),g.lineTo(k.handles.end.x,k.handles.end.y),g.moveTo(k.handles.start2.x,k.handles.start2.y),g.lineTo(k.handles.end2.x,k.handles.end2.y),g.stroke(),g.beginPath(),d.drawHandles(g,c,k.handles),g.stroke(),g.fillStyle=i;var l=(Math.ceil(k.handles.start.x)-Math.ceil(k.handles.end.x))*c.image.columnPixelSpacing,m=(Math.ceil(k.handles.start.y)-Math.ceil(k.handles.end.y))*c.image.rowPixelSpacing,n=(Math.ceil(k.handles.start2.x)-Math.ceil(k.handles.end2.x))*c.image.columnPixelSpacing,o=(Math.ceil(k.handles.start2.y)-Math.ceil(k.handles.end2.y))*c.image.rowPixelSpacing,p=Math.acos(Math.abs((l*n+m*o)/(Math.sqrt(l*l+m*m)*Math.sqrt(n*n+o*o))));p*=180/Math.PI;var q=d.roundToDecimal(p,2),r="00B0",s=q.toString()+String.fromCharCode(parseInt(r,16)),t=d.setContextToDisplayFontSize(c.enabledElement,c.canvasContext,15);g.font=""+t.fontSize+"px Arial";var u=(k.handles.start2.x+k.handles.end2.x)/2/t.fontScale,v=(k.handles.start2.y+k.handles.end2.y)/2/t.fontScale;g.fillText(s,u,v),g.restore()}}}void 0===d&&(d={});var h="angle";return d.angle=d.mouseButtonTool({createNewMeasurement:e,onImageRendered:g,pointNearTool:f,toolType:h}),d.angleTouch=d.touchTool({createNewMeasurement:e,onImageRendered:g,pointNearTool:f,toolType:h}),d}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(a,b,c,d){"use strict";function e(c){function e(a){null!==a?f.annotationText=a:d.removeToolState(c.element,C,f),b.updateImage(c.element)}var f=j(c);d.addToolState(c.element,C,f),a(c.element).off("CornerstoneToolsMouseMove",g),d.moveHandle(c,f.handles.end,function(){d.anyHandlesOutsideImage(c,f.handles)&&d.removeToolState(c.element,C,f);var b=d.arrowAnnotate.getConfiguration();void 0===f.annotationText&&b.getTextCallback(e),a(c.element).on("CornerstoneToolsMouseMove",g)})}function f(a,b){return d.isMouseButtonEnabled(b.which,a.data.mouseButtonMask)?(e(b),!1):void 0}function g(a,c){if(d.toolCoordinates.setCoords(c),0===c.which){var e=d.getToolState(c.element,C);if(void 0!==e){for(var f=!1,g=0;g<e.data.length;g++){var h=e.data[g];d.handleActivator(h.handles,c.currentPoints.image,c.viewport.scale)===!0&&(f=!0)}return f===!0&&b.updateImage(c.element),!1}}}function h(a,b){for(var d in a.handles){var e=c.point.distanceSquared(a.handles[d],b);if(25>e)return a.handles[d]}}function i(b,c){function e(){d.anyHandlesOutsideImage(c,f.handles)&&d.removeToolState(c.element,C,f),a(c.element).on("CornerstoneToolsMouseMove",g)}var f;if(d.isMouseButtonEnabled(c.which,b.data.mouseButtonMask)){var i,j=c.startPoints.image,l=d.getToolState(b.currentTarget,C);if(void 0!==l)for(i=0;i<l.data.length;i++){f=l.data[i];var m=h(f,j);if(void 0!==m)return a(c.element).off("CornerstoneToolsMouseMove",g),d.moveHandle(c,m,e),b.stopImmediatePropagation(),!1}if(void 0!==l&&void 0!==k)for(i=0;i<l.data.length;i++)if(f=l.data[i],k(f,j))return a(c.element).off("CornerstoneToolsMouseMove",g),d.moveAllHandles(b,f,l,!0),b.stopImmediatePropagation(),!1;return!1}}function j(a){var b={visible:!0,active:!0,handles:{start:{x:a.currentPoints.image.x,y:a.currentPoints.image.y,highlight:!0,active:!1},end:{x:a.currentPoints.image.x,y:a.currentPoints.image.y,highlight:!0,active:!0}}};return b}function k(a,b){var d={start:a.handles.start,end:a.handles.end},e=c.lineSegment.distanceToPoint(d,b);return 25>e}function l(a,b,c,d,e){var f=10,g=Math.atan2(c.y-b.y,c.x-b.x);a.beginPath(),a.moveTo(b.x,b.y),a.lineTo(c.x,c.y),a.strokeStyle=d,a.lineWidth=e,a.stroke(),a.beginPath(),a.moveTo(c.x,c.y),a.lineTo(c.x-f*Math.cos(g-Math.PI/7),c.y-f*Math.sin(g-Math.PI/7)),a.lineTo(c.x-f*Math.cos(g+Math.PI/7),c.y-f*Math.sin(g+Math.PI/7)),a.lineTo(c.x,c.y),a.lineTo(c.x-f*Math.cos(g-Math.PI/7),c.y-f*Math.sin(g-Math.PI/7)),a.strokeStyle=d,a.lineWidth=e,a.stroke(),a.fillStyle=d,a.fill()}function m(a,c){var e=d.getToolState(a.currentTarget,C);if(void 0!==e){var f=d.arrowAnnotate.getConfiguration(),g=c.canvasContext.canvas.getContext("2d");g.setTransform(1,0,0,1,0,0);for(var h,i=0;i<e.data.length;i++){var j=e.data[i];k(j,d.toolCoordinates.getCoords())?(j.active=!0,h=d.toolColors.getActiveColor()):(j.active=!1,h=d.toolColors.getToolColor());var m=1/c.viewport.scale,n=b.pixelToCanvas(c.element,j.handles.start),o=b.pixelToCanvas(c.element,j.handles.end);if(f.arrowFirst?l(g,o,n,h,m):l(g,n,o,h,m),f.drawHandles!==!1&&(g.beginPath(),d.drawHandles(g,c,j.handles,h),g.stroke()),void 0!==j.annotationText&&null!==j.annotationText){g.fillStyle=h,g.font="14px Arial";var p={x:(n.x+o.x)/2,y:(n.y+o.y)/2};g.fillText(j.annotationText,p.x,p.y)}}}}function n(c){a(c).off("CornerstoneImageRendered",m),a(c).off("CornerstoneToolsMouseMove",g),a(c).off("CornerstoneToolsMouseDown",i),a(c).off("CornerstoneToolsMouseDownActivate",f),b.updateImage(c)}function o(c){a(c).off("CornerstoneImageRendered",m),a(c).off("CornerstoneToolsMouseMove",g),a(c).off("CornerstoneToolsMouseDown",i),a(c).off("CornerstoneToolsMouseDownActivate",f),a(c).on("CornerstoneImageRendered",m),b.updateImage(c)}function p(c,d){var e={mouseButtonMask:d};a(c).off("CornerstoneImageRendered",m),a(c).off("CornerstoneToolsMouseMove",g),a(c).off("CornerstoneToolsMouseDown",i),a(c).off("CornerstoneToolsMouseDownActivate",f),a(c).on("CornerstoneImageRendered",m),a(c).on("CornerstoneToolsMouseMove",e,g),a(c).on("CornerstoneToolsMouseDown",e,i),a(c).on("CornerstoneToolsMouseDownActivate",e,f),b.updateImage(c)}function q(c,d){var e={mouseButtonMask:d};a(c).off("CornerstoneImageRendered",m),a(c).off("CornerstoneToolsMouseMove",g),a(c).off("CornerstoneToolsMouseDown",i),a(c).off("CornerstoneToolsMouseDownActivate",f),a(c).on("CornerstoneImageRendered",m),a(c).on("CornerstoneToolsMouseMove",e,g),a(c).on("CornerstoneToolsMouseDown",e,i),b.updateImage(c)}function r(c){function e(a){null!==a?f.annotationText=a:d.removeToolState(c.element,C,f),b.updateImage(c.element)}var f=j(c);d.addToolState(c.element,C,f),a(c.element).off("CornerstoneToolsTouchDrag",t),d.touchmoveHandle(c,f.handles.end,function(){d.anyHandlesOutsideImage(c,f.handles)&&d.removeToolState(c.element,C,f);var b=d.arrowAnnotate.getConfiguration();void 0===f.annotationText&&b.getTextCallback(e),a(c.element).on("CornerstoneToolsTouchDrag",t)})}function s(a,b){return r(b),!1}function t(a,c){d.toolCoordinates.setCoords(c);var e=d.getToolState(c.element,C);if(void 0!==e){for(var f=!1,g=0;g<e.data.length;g++){var h=e.data[g];d.handleActivator(h.handles,c.currentPoints.image,c.viewport.scale)===!0&&(f=!0)}return f===!0&&b.updateImage(c.element),!1}}function u(a,b){for(var d in a.handles){var e=c.point.distanceSquared(a.handles[d],b);if(30>e)return a.handles[d]}}function v(b,c){function e(){d.anyHandlesOutsideImage(c,f.handles)&&d.removeToolState(c.element,C,f),a(c.element).on("CornerstoneToolsTouchDrag",t)}var f,g,h=c.startPoints.image,i=d.getToolState(b.currentTarget,C);if(void 0!==i)for(g=0;g<i.data.length;g++){f=i.data[g];var j=u(f,h);if(void 0!==j)return a(c.element).off("CornerstoneToolsTouchDrag",t),d.touchmoveHandle(c,j,e),b.stopImmediatePropagation(),!1}if(void 0!==i&&void 0!==k)for(g=0;g<i.data.length;g++)if(f=i.data[g],k(f,h))return a(c.element).off("CornerstoneToolsTouchDrag",t),d.touchmoveAllHandles(b,f,i,!0),b.stopImmediatePropagation(),!1;return!1}function w(c){a(c).off("CornerstoneImageRendered",m),a(c).off("CornerstoneToolsTouchDrag",t),a(c).off("CornerstoneToolsDragStart",v),a(c).off("CornerstoneToolsDragStartActive",s),b.updateImage(c)}function x(c){a(c).off("CornerstoneImageRendered",m),a(c).off("CornerstoneToolsTouchDrag",t),a(c).off("CornerstoneToolsDragStart",v),a(c).off("CornerstoneToolsDragStartActive",s),a(c).on("CornerstoneImageRendered",m),b.updateImage(c)}function y(c){a(c).off("CornerstoneImageRendered",m),a(c).off("CornerstoneToolsTouchDrag",t),a(c).off("CornerstoneToolsDragStart",v),a(c).off("CornerstoneToolsDragStartActive",s),a(c).on("CornerstoneImageRendered",m),a(c).on("CornerstoneToolsTouchDrag",t),a(c).on("CornerstoneToolsDragStart",v),a(c).on("CornerstoneToolsDragStartActive",eventData,s),b.updateImage(c)}function z(c){a(c).off("CornerstoneImageRendered",m),a(c).off("CornerstoneToolsTouchDrag",t),a(c).off("CornerstoneToolsDragStart",v),a(c).off("CornerstoneToolsDragStartActive",s),a(c).on("CornerstoneImageRendered",m),a(c).on("CornerstoneToolsTouchDrag",t),a(c).on("CornerstoneToolsDragStart",v),b.updateImage(c)}function A(){return D}function B(a){D=a}void 0===d&&(d={});var C="arrowAnnotate",D={};return d.arrowAnnotate={enable:o,disable:n,activate:p,deactivate:q,getConfiguration:A,setConfiguration:B},d.arrowAnnotateTouch={enable:x,disable:w,activate:y,deactivate:z},d}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(d,e){var f=c.getToolState(d.currentTarget,j);if(void 0!==f){var g=d.currentTarget,h=b.getEnabledElement(g),i=h.image.imageId,k=c.metaData.get("imagePlane",i),l=e.currentPoints.image,m=c.imagePointToPatientPoint(l,k),n=f.data[0].synchronizationContext,o=n.getSourceElements();a.each(o,function(d,e){if(e!==g){var f=Number.MAX_VALUE,h=-1,i=c.getToolState(e,"stack");if(void 0!==i){var j=i.data[0];a.each(j.imageIds,function(a,b){var d=c.metaData.get("imagePlane",b),e=d.imagePositionPatient,g=d.rowCosines.clone(),i=d.columnCosines.clone(),j=i.clone().cross(g.clone()),k=Math.abs(j.clone().dot(e)-j.clone().dot(m));f>k&&(f=k,h=a)}),h!==j.currentImageIdIndex&&-1!==h&&void 0!==j.imageIds[h]&&b.loadAndCacheImage(j.imageIds[h]).then(function(a){var c=b.getViewport(e);j.currentImageIdIndex=h,b.displayImage(e,a,c)})}}})}}function e(b,c){a(c.element).off("CornerstoneToolsMouseDrag",g),a(c.element).off("CornerstoneToolsMouseUp",e)}function f(b,f){return c.isMouseButtonEnabled(f.which,b.data.mouseButtonMask)?(a(f.element).on("CornerstoneToolsMouseDrag",g),a(f.element).on("CornerstoneToolsMouseUp",e),d(b,f),!1):void 0}function g(a,b){return d(a,b),!1}function h(d,e,g){var h={mouseButtonMask:e};c.addToolState(d,j,{synchronizationContext:g}),a(d).off("CornerstoneToolsMouseDown",f),a(d).on("CornerstoneToolsMouseDown",h,f),b.updateImage(d)}function i(c){a(c).off("CornerstoneToolsMouseDown",f),b.updateImage(c)}void 0===c&&(c={});var j="crosshairs";return c.crosshairs={enable:h,disable:i},c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c,d){"use strict";function e(a){var b={visible:!0,handles:{start:{x:a.currentPoints.image.x,y:a.currentPoints.image.y,highlight:!0,active:!1},end:{x:a.currentPoints.image.x,y:a.currentPoints.image.y,highlight:!0,active:!0}}};return b}function f(a,b){var d={left:Math.min(a.handles.start.x,a.handles.end.x),top:Math.min(a.handles.start.y,a.handles.end.y),width:Math.abs(a.handles.start.x-a.handles.end.x),height:Math.abs(a.handles.start.y-a.handles.end.y)},e=c.rect.distanceToPoint(d,b);return 5>e}function g(a,b){var c=a.width/2,d=a.height/2;if(0>=c||0>=d)return!1;var e={x:a.left+c,y:a.top+d},f={x:b.x-e.x,y:b.y-e.y},g=f.x*f.y/(c*c)+f.y*f.y/(d*d)<=1;return g}function h(a,b){for(var c=0,d=0,e=0,f=0,h=b.top;h<b.top+b.height;h++)for(var i=b.left;i<b.left+b.width;i++)g(b,{x:i,y:h})===!0&&(c+=a[f],d+=a[f]*a[f],e++),f++;if(0===e)return{count:e,mean:0,variance:0,stdDev:0};var j=c/e,k=d/e-j*j;return{count:e,mean:j,variance:k,stdDev:Math.sqrt(k)}}function i(a,c){var e=d.getToolState(a.currentTarget,j);if(void 0!==e){var g=c.canvasContext.canvas.getContext("2d");b.setToPixelCoordinateSystem(c.enabledElement,g);for(var i,k=0;k<e.data.length;k++){g.save();var l=e.data[k];f(l,d.toolCoordinates.getCoords())?(l.active=!0,i=d.toolColors.getActiveColor()):(l.active=!1,i=d.toolColors.getToolColor());var m=Math.abs(l.handles.start.x-l.handles.end.x),n=Math.abs(l.handles.start.y-l.handles.end.y),o=Math.min(l.handles.start.x,l.handles.end.x),p=Math.min(l.handles.start.y,l.handles.end.y),q=(l.handles.start.x+l.handles.end.x)/2,r=(l.handles.start.y+l.handles.end.y)/2;g.beginPath(),g.strokeStyle=i,g.lineWidth=1/c.viewport.scale,d.drawEllipse(g,o,p,m,n),g.closePath(),g.beginPath(),d.drawHandles(g,c,l.handles),g.stroke();var s=b.getPixels(c.element,o,p,m,n),t={left:o,top:p,width:m,height:n},u=h(s,t),v=Math.PI*(m*c.image.columnPixelSpacing/2)*(n*c.image.rowPixelSpacing/2),w="Area: "+v.toFixed(2)+" mm^2",x=d.setContextToDisplayFontSize(c.enabledElement,c.canvasContext,15);g.font=""+x.fontSize+"px Arial";var y=g.measureText(v),z=x.lineHeight,A=q<c.image.columns/2?q+m/2:q-m/2-y.width*x.fontScale,B=r<c.image.rows/2?r+n/2:r-n/2;A/=x.fontScale,B/=x.fontScale,g.fillStyle=i,g.fillText("Mean: "+u.mean.toFixed(2),A,B-z),g.fillText("StdDev: "+u.stdDev.toFixed(2),A,B),g.fillText(w,A,B+z),g.restore()}}}void 0===d&&(d={});var j="ellipticalRoi";return d.ellipticalRoi=d.mouseButtonTool({createNewMeasurement:e,onImageRendered:i,pointNearTool:f,toolType:j}),d.ellipticalroi_Touch=d.touchTool({createNewMeasurement:e,onImageRendered:i,pointNearTool:f,toolType:j}),d}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(a,b,c,d){"use strict";function e(a){var c=d.getToolState(a.element,r);if(void 0!==c){var e=c.data[u],f={x:a.currentPoints.image.x,y:a.currentPoints.image.y,highlight:!0,active:!0,lines:[]};0!==e.handles.length&&e.handles[t].lines.push(a.currentPoints.image),e.handles.push(f),t+=1,v=!1,b.updateImage(a.element)}}function f(a,b){var e=d.getToolState(a.element,r);if(void 0!==e){var f=e.data[b];if(void 0!==f.handles){for(var g=a.currentPoints.image,h=0;h<f.handles.length;h++)if(c.point.distance(f.handles[h],g)<5)return h;return-1}}}function g(a){var b=d.getToolState(a.element,r);if(void 0!==b)for(var c,e=0;e<b.data.length;e++)if(c=f(a,e),c>-1)return[c,e]}function h(c,e){a(e.element).off("CornerstoneToolsMouseUp",h);var f=d.getToolState(e.element,r);void 0!==f&&(e.event.shiftKey||(v=!1),b.updateImage(e.element))}function i(a,c){var e=d.getToolState(c.element,r);if(void 0!==e){var g=e.data[u];if(s.handles.start.x=c.currentPoints.image.x,s.handles.start.y=c.currentPoints.image.y,w&&(g.active=!0,g.highlight=!0,g.handles[t].x=s.handles.start.x,g.handles[t].y=s.handles.start.y,0!==t)){var h=g.handles[t-1].lines.length-1,i=g.handles[t-1].lines[h];i.x=s.handles.start.x,i.y=s.handles.start.y}if(v)g.handles[t].lines.push(c.currentPoints.image);else{var j=f(c,u);j>-1&&j<g.handles.length-1&&(s.handles.start.x=g.handles[j].x,s.handles.start.y=g.handles[j].y)}b.updateImage(c.element)}}function j(b){a(b.element).on("CornerstoneToolsMouseMove",i),a(b.element).on("CornerstoneToolsMouseUp",h);var c={visible:!0,active:!0,handles:[]};s.handles.start.x=b.currentPoints.image.x,s.handles.start.y=b.currentPoints.image.y,d.addToolState(b.element,r,c);var e=d.getToolState(b.element,r);u=e.data.length-1}function k(c,e){var f=d.getToolState(c.element,r);if(void 0!==f){var g=f.data[u];g.active=!1,g.highlight=!1,void 0!==e&&g.handles[t].lines.push(g.handles[e]),w&&(w=!1),t=-1,u=-1,a(c.element).off("CornerstoneToolsMouseMove",i),b.updateImage(c.element)}}function l(b,c){if(d.isMouseButtonEnabled(c.which,b.data.mouseButtonMask)){var l,m,n=d.getToolState(c.element,r);if(u>=0&&(l=f(c,u)),void 0===n&&(u=0),w)return void k(c);if(void 0===n||0>u){var o=g(c);void 0!==o?(l=o[0],m=o[1],0>t&&l>=0&&(a(c.element).on("CornerstoneToolsMouseMove",i),a(c.element).on("CornerstoneToolsMouseUp",h),w=!0,t=l,u=m)):(j(c),e(c))}else n.data[u].active&&(l>-1?k(c,l):c.event.shiftKey?v=!0:e(c));return!1}}function m(a,c){var e=d.getToolState(a.currentTarget,r);if(void 0!==e){var f=c.canvasContext.canvas.getContext("2d");b.setToPixelCoordinateSystem(c.enabledElement,f);for(var g,h=d.toolStyle.getToolWidth(),i=d.toolColors.getFillColor(),j=0;j<e.data.length;j++){f.save();var k=e.data[j];k.active?(g=d.toolColors.getActiveColor(),i=d.toolColors.getFillColor()):(g=d.toolColors.getToolColor(),i=d.toolColors.getToolColor());var l;if(k.handles.length>0)for(var m=0;m<k.handles.length;m++){l=k.handles[m],f.beginPath(),f.strokeStyle=g,f.lineWidth=h/c.viewport.scale,f.moveTo(l.x,l.y);for(var n=0;n<k.handles[m].lines.length;n++){var o=k.handles[m].lines[n];f.lineTo(o.x,o.y),f.stroke()}m===k.handles.length-1&&(!k.active||v||w||(f.lineTo(s.handles.start.x,s.handles.start.y),f.stroke()))}f.beginPath(),k.active&&d.drawHandles(f,c,s.handles,g,i),d.drawHandles(f,c,k.handles,g,i),f.stroke(),f.restore()}}}function n(c){a(c).off("CornerstoneToolsMouseDown",l),a(c).off("CornerstoneToolsMouseUp",h),a(c).off("CornerstoneToolsMouseMove",i),a(c).off("CornerstoneImageRendered",m),a(c).on("CornerstoneImageRendered",m),b.updateImage(c)}function o(c){a(c).off("CornerstoneToolsMouseDown",l),a(c).off("CornerstoneToolsMouseUp",h),a(c).off("CornerstoneToolsMouseMove",i),a(c).off("CornerstoneImageRendered",m),b.updateImage(c)
}function p(c,d){var e={mouseButtonMask:d};a(c).off("CornerstoneToolsMouseDown",l),a(c).off("CornerstoneToolsMouseUp",h),a(c).off("CornerstoneToolsMouseMove",i),a(c).off("CornerstoneImageRendered",m),a(c).on("CornerstoneImageRendered",m),a(c).on("CornerstoneToolsMouseDown",e,l),b.updateImage(c)}function q(c,d){a(c).off("CornerstoneToolsMouseDown",l),a(c).off("CornerstoneToolsMouseUp",h),a(c).off("CornerstoneToolsMouseMove",i),a(c).off("CornerstoneImageRendered",m),a(c).on("CornerstoneImageRendered",mouseToolInterface.onImageRendered),b.updateImage(c)}void 0===d&&(d={});var r="freehand",s={handles:{start:{highlight:!0,active:!0}}},t=-1,u=0,v=!0,w=!1;return d.freehand={enable:n,disable:o,activate:p,deactivate:q},d}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(a,b,c,d){"use strict";function e(a){var b=d.getToolState(a.event.currentTarget,i);if(!(b&&b.data&&b.data.length>0)){var c={visible:!0,handles:{start:{x:a.currentPoints.image.x,y:a.currentPoints.image.y,highlight:!0,active:!1},end:{x:a.currentPoints.image.x,y:a.currentPoints.image.y,highlight:!0,active:!0}}};return c}}function f(a,b){var c={left:Math.min(a.handles.start.x,a.handles.end.x),top:Math.min(a.handles.start.y,a.handles.end.y),width:Math.abs(a.handles.start.x-a.handles.end.x),height:Math.abs(a.handles.start.y-a.handles.end.y)},d=!1;return b.x>=c.left&&b.x<=c.left+c.width&&b.y>=c.top&&b.y<=c.top+c.height&&(d=!0),d}function g(a,b){var d={left:Math.min(a.handles.start.x,a.handles.end.x),top:Math.min(a.handles.start.y,a.handles.end.y),width:Math.abs(a.handles.start.x-a.handles.end.x),height:Math.abs(a.handles.start.y-a.handles.end.y)},e=c.rect.distanceToPoint(d,b);return 5>e}function h(a,c){var e=d.getToolState(a.currentTarget,i);if(void 0!==e){var f=c.canvasContext.canvas.getContext("2d");b.setToPixelCoordinateSystem(c.enabledElement,f);var h;f.save();var j=e.data[0];if(j){g(j,d.toolCoordinates.getCoords())?(j.active=!0,h=d.toolColors.getActiveColor()):(j.active=!1,h=d.toolColors.getToolColor());var k={left:Math.min(j.handles.start.x,j.handles.end.x),top:Math.min(j.handles.start.y,j.handles.end.y),width:Math.abs(j.handles.start.x-j.handles.end.x),height:Math.abs(j.handles.start.y-j.handles.end.y)};f.beginPath(),f.strokeStyle="transparent",f.save(),f.setTransform(1,0,0,1,0,0),f.rect(0,0,f.canvas.clientWidth,f.canvas.clientHeight),f.restore(),f.rect(k.width+k.left,k.top,-k.width,k.height),f.restore(),f.stroke(),f.fillStyle="rgba(0,0,0,0.7)",f.fill(),f.closePath(),f.beginPath(),f.strokeStyle=h,f.lineWidth=2.5/c.viewport.scale,f.setLineDash([4]),f.strokeRect(k.left,k.top,k.width,k.height),f.restore(),f.beginPath(),d.drawHandles(f,c,j.handles,h),f.stroke()}}}void 0===d&&(d={});var i="highlight",j=!0;return d.highlight=d.mouseButtonRectangleTool({createNewMeasurement:e,onImageRendered:h,pointNearTool:g,pointInsideRect:f,toolType:i},j),d.highlightTouch=d.touchTool({createNewMeasurement:e,onImageRendered:h,pointNearTool:g,pointInsideRect:f,toolType:i},j),d}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(a,b,c,d){"use strict";function e(a){var b={visible:!0,handles:{start:{x:a.currentPoints.image.x,y:a.currentPoints.image.y,highlight:!0,active:!1},end:{x:a.currentPoints.image.x,y:a.currentPoints.image.y,highlight:!0,active:!0}}};return b}function f(a,b){var d={start:a.handles.start,end:a.handles.end},e=c.lineSegment.distanceToPoint(d,b);return 25>e}function g(a,c){var e=d.getToolState(a.currentTarget,h);if(void 0!==e){var g=c.canvasContext.canvas.getContext("2d");b.setToPixelCoordinateSystem(c.enabledElement,g);for(var i,j=0;j<e.data.length;j++){g.save();var k=e.data[j];f(k,d.toolCoordinates.getCoords())?(k.active=!0,i=d.toolColors.getActiveColor()):(k.active=!1,i=d.toolColors.getToolColor()),g.beginPath(),g.strokeStyle=i,g.lineWidth=1/c.viewport.scale,g.moveTo(k.handles.start.x,k.handles.start.y),g.lineTo(k.handles.end.x,k.handles.end.y),g.stroke(),g.beginPath(),d.drawHandles(g,c,k.handles,i),g.stroke(),g.fillStyle=i;var l=(k.handles.start.x-k.handles.end.x)*c.image.columnPixelSpacing,m=(k.handles.start.y-k.handles.end.y)*c.image.rowPixelSpacing,n=Math.sqrt(l*l+m*m),o=""+n.toFixed(2)+" mm",p=d.setContextToDisplayFontSize(c.enabledElement,c.canvasContext,15);g.font=""+p.fontSize+"px Arial";var q=(k.handles.start.x+k.handles.end.x)/2/p.fontScale,r=(k.handles.start.y+k.handles.end.y)/2/p.fontScale;g.fillText(o,q,r),g.restore()}}}void 0===d&&(d={});var h="length";return d.length=d.mouseButtonTool({createNewMeasurement:e,onImageRendered:g,pointNearTool:f,toolType:h}),d.lengthTouch=d.touchTool({createNewMeasurement:e,onImageRendered:g,pointNearTool:f,toolType:h}),d}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(b,c){a(c.element).off("CornerstoneToolsMouseDrag",g),a(c.element).off("CornerstoneToolsMouseUp",d),e(c)}function e(b){a(b.element).find(".magnifyTool").hide(),document.body.style.cursor="default"}function f(b,e){return c.isMouseButtonEnabled(e.which,b.data.mouseButtonMask)?(a(e.element).on("CornerstoneToolsMouseDrag",e,g),a(e.element).on("CornerstoneToolsMouseUp",e,d),h(e),!1):void 0}function g(a,b){return h(b),!1}function h(b){var d=a(b.element).find(".magnifyTool").get(0);void 0===d&&i(b.element);var e=c.magnify.getConfiguration(),f=e.magnifySize,g=e.magnificationLevel,h=a(b.element).find("canvas").not(".magnifyTool").get(0),j=d.getContext("2d"),k=h.getBoundingClientRect(),l={x:b.currentPoints.client.x-k.left,y:b.currentPoints.client.y-k.top};j.clearRect(0,0,d.width,d.height),j.fillStyle="transparent",j.fillRect(0,0,d.width,d.height),j.drawImage(h,l.x-f/4,l.y-f/4,f,f,0,0,f*g,f*g),d.style.top=l.y-f/2+"px",d.style.left=l.x-f/2+"px",d.style.display="block",document.body.style.cursor="none"}function i(b){if(0===a(b).find(".magnifyTool").length){var d=document.createElement("canvas");d.classList.add("magnifyTool");var e=c.magnify.getConfiguration();d.width=e.magnifySize,d.height=e.magnifySize,d.style.position="absolute",b.appendChild(d)}}function j(b){a(b).find(".magnifyTool").remove()}function k(b){a(b).off("CornerstoneToolsMouseDown",f),j(b)}function l(a){var b=c.magnify.getConfiguration(b);Object.keys(b).length||(b={magnifySize:100,magnificationLevel:2},c.magnify.setConfiguration(b)),i(a)}function m(b,c){var d={mouseButtonMask:c};a(b).off("CornerstoneToolsMouseDown",f),a(b).on("CornerstoneToolsMouseDown",d,f),i(b)}function n(b){a(b).off("CornerstoneToolsTouchDrag",g),a(b).off("CornerstoneToolsDragStart",g),j(b)}function o(b){a(b).off("CornerstoneToolsTouchDrag",g),a(b).off("CornerstoneToolsDragStart",g),a(b).on("CornerstoneToolsTouchDrag",g),a(b).on("CornerstoneToolsDragStart",g),i(b)}function p(){return r}function q(a){r=a}void 0===c&&(c={});var r={};return c.magnify={enable:l,activate:m,deactivate:k,disable:k,getConfiguration:p,setConfiguration:q},c.magnifyTouchDrag={enable:l,activate:o,deactivate:n,disable:n},c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(b,c){a(c.element).off("CornerstoneToolsMouseDrag",f),a(c.element).off("CornerstoneToolsMouseUp",d)}function e(b,e){return c.isMouseButtonEnabled(e.which,b.data.mouseButtonMask)?(a(e.element).on("CornerstoneToolsMouseDrag",f),a(e.element).on("CornerstoneToolsMouseUp",d),!1):void 0}function f(a,c){return c.viewport.translation.x+=c.deltaPoints.page.x/c.viewport.scale,c.viewport.translation.y+=c.deltaPoints.page.y/c.viewport.scale,b.setViewport(c.element,c.viewport),!1}function g(a,c){var d=c;return d.viewport.translation.x+=d.deltaPoints.page.x/d.viewport.scale,d.viewport.translation.y+=d.deltaPoints.page.y/d.viewport.scale,b.setViewport(d.element,d.viewport),!1}return void 0===c&&(c={}),c.pan=c.simpleMouseButtonTool(e),c.panTouchDrag=c.touchDragTool(g),c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(a){var b={visible:!0,handles:{end:{x:a.currentPoints.image.x,y:a.currentPoints.image.y,highlight:!0,active:!0}}};return b}function e(a,b){if(void 0===a.data)return void 0;if("PT"!==a.data.string("x00080060"))return void 0;var c=b*a.slope+a.intercept,d=a.data.floatString("x00101030");if(void 0===d)return void 0;var e=a.data.elements.x00540016;if(void 0===e)return void 0;e=e.items[0].dataSet;var f=e.time("x00181072"),g=e.floatString("x00181074"),h=e.floatString("x00181075"),i=a.data.time("x00080032");if(void 0===f||void 0===g||void 0===h||void 0===i)return void 0;var j=i.fractionalSeconds+i.seconds+60*i.minutes+60*i.hours*60,k=f.fractionalSeconds+f.seconds+60*f.minutes+60*f.hours*60,l=j-k,m=g*Math.exp(-l*Math.log(2)/h),n=c*d/m*1e3;return n}function f(a,b){return cornerstoneMath.point.distance(a.handles.end,b)<5}function g(a,d){var g=c.getToolState(a.currentTarget,h);if(void 0!==g){var i=d.canvasContext.canvas.getContext("2d");b.setToPixelCoordinateSystem(d.enabledElement,i);for(var j,k=0;k<g.data.length;k++){i.save();var l=g.data[k];f(l,c.toolCoordinates.getCoords())?(l.active=!0,j=c.toolColors.getActiveColor()):(l.active=!1,j=c.toolColors.getToolColor()),i.beginPath(),c.drawHandles(i,d,l.handles,j),i.stroke();var m=c.setContextToDisplayFontSize(d.enabledElement,d.canvasContext,15);i.font=""+m.fontSize+"px Arial";var n=Math.round(l.handles.end.x),o=Math.round(l.handles.end.y);p=l.handles.end.x+3,q=l.handles.end.y-3;var p=p/m.fontScale,q=q/m.fontScale;i.fillStyle=j;var r=b.getStoredPixels(d.element,n,o,1,1),s=r[0],t=s*d.image.slope+d.image.intercept,u=e(d.image,s);i.fillText(""+n+","+o,p,q);var v="SP: "+s+" MO: "+t.toFixed(3);void 0!==u&&(v+=" SUV: "+u.toFixed(3)),i.fillText(v,p,q+m.lineHeight),i.restore()}}}void 0===c&&(c={});var h="probe";return c.probe=c.mouseButtonTool({createNewMeasurement:d,onImageRendered:g,toolType:h}),c.probeTouch=c.touchTool({createNewMeasurement:d,onImageRendered:g,toolType:h}),c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c,d){"use strict";function e(a){var b={visible:!0,handles:{start:{x:a.currentPoints.image.x,y:a.currentPoints.image.y,highlight:!0,active:!1},end:{x:a.currentPoints.image.x,y:a.currentPoints.image.y,highlight:!0,active:!0}}};return b}function f(a,b){var d={left:Math.min(a.handles.start.x,a.handles.end.x),top:Math.min(a.handles.start.y,a.handles.end.y),width:Math.abs(a.handles.start.x-a.handles.end.x),height:Math.abs(a.handles.start.y-a.handles.end.y)},e=c.rect.distanceToPoint(d,b);return 5>e}function g(a,b){for(var c=0,d=0,e=0,f=0,g=b.top;g<b.top+b.height;g++)for(var h=b.left;h<b.left+b.width;h++)c+=a[f],d+=a[f]*a[f],e++,f++;if(0===e)return{count:e,mean:0,variance:0,stdDev:0};var i=c/e,j=d/e-i*i;return{count:e,mean:i,variance:j,stdDev:Math.sqrt(j)}}function h(a,c){var e=d.getToolState(a.currentTarget,i);if(void 0!==e){var h=c.canvasContext.canvas.getContext("2d");b.setToPixelCoordinateSystem(c.enabledElement,h);for(var j,k=0;k<e.data.length;k++){h.save();var l=e.data[k];f(l,d.toolCoordinates.getCoords())?(l.active=!0,j=d.toolColors.getActiveColor()):(l.active=!1,j=d.toolColors.getToolColor());var m=Math.abs(l.handles.start.x-l.handles.end.x),n=Math.abs(l.handles.start.y-l.handles.end.y),o=Math.min(l.handles.start.x,l.handles.end.x),p=Math.min(l.handles.start.y,l.handles.end.y),q=(l.handles.start.x+l.handles.end.x)/2,r=(l.handles.start.y+l.handles.end.y)/2;h.beginPath(),h.strokeStyle=j,h.lineWidth=1/c.viewport.scale,h.rect(o,p,m,n),h.stroke(),h.beginPath(),d.drawHandles(h,c,l.handles,j),h.stroke();var s=b.getPixels(c.element,o,p,m,n),t={left:o,top:p,width:m,height:n},u=g(s,t),v=m*c.image.columnPixelSpacing*n*c.image.rowPixelSpacing,w="Area: "+v.toFixed(2)+" mm^2",x=d.setContextToDisplayFontSize(c.enabledElement,c.canvasContext,15);h.font=""+x.fontSize+"px Arial";var y=h.measureText(v),z=x.lineHeight,A=q<c.image.columns/2?q+m/2:q-m/2-y.width*x.fontScale,B=r<c.image.rows/2?r+n/2:r-n/2;A/=x.fontScale,B/=x.fontScale,h.fillStyle=j,h.fillText("Mean: "+u.mean.toFixed(2),A,B-z),h.fillText("StdDev: "+u.stdDev.toFixed(2),A,B),h.fillText(w,A,B+z),h.restore()}}}void 0===d&&(d={});var i="rectangleRoi";return d.rectangleRoi=d.mouseButtonTool({createNewMeasurement:e,onImageRendered:h,pointNearTool:f,toolType:i}),d.rectangleRoiTouch=d.touchTool({createNewMeasurement:e,onImageRendered:h,pointNearTool:f,toolType:i}),d}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(a){var b=a.element.getBoundingClientRect(a.element),c={x:a.currentPoints.client.x,y:a.currentPoints.client.y},d=a.element.clientWidth,e=a.element.clientHeight,f={x:c.x-b.left-d/2,y:-1*(c.y-b.top-e/2)},g=Math.atan2(f.y,f.x),h=g*(180/Math.PI),i=-1*h+90;a.viewport.rotation=i}function e(a){a.viewport.rotation+=a.deltaPoints.page.x/a.viewport.scale}function f(a){a.viewport.rotation+=a.deltaPoints.page.y/a.viewport.scale}function g(b,c){a(c.element).off("CornerstoneToolsMouseDrag",i),a(c.element).off("CornerstoneToolsMouseUp",g)}function h(b,d){return c.isMouseButtonEnabled(d.which,b.data.mouseButtonMask)?(a(d.element).on("CornerstoneToolsMouseDrag",i),a(d.element).on("CornerstoneToolsMouseUp",g),!1):void 0}function i(a,d){return c.rotate.strategy(d),b.setViewport(d.element,d.viewport),a.stopPropagation(),!1}function j(a,d){return c.rotate.strategy(d),b.setViewport(d.element,d.viewport),!1}return void 0===c&&(c={}),c.rotate=c.simpleMouseButtonTool(h),c.rotate.strategies={"default":d,horizontal:e,vertical:f},c.rotate.strategy=d,c.rotateTouchDrag=c.touchDragTool(j),c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(b,c){var d,e=a(b).find("canvas").get(0),f=document.createElement("a");f.download=c,f.href=e.toDataURL(),document.createEvent?(d=document.createEvent("MouseEvents"),d.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),f.dispatchEvent(d)):f.fireEvent&&f.fireEvent("onclick")}return void 0===c&&(c={}),c.saveAs=d,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(a){var b=c.textMarker.getConfiguration();if(b.current){var d={visible:!0,text:b.current,handles:{end:{x:a.currentPoints.image.x,y:a.currentPoints.image.y,highlight:!0,active:!0}}},e=b.markers.indexOf(b.current);return b.ascending?(e+=1,e>=b.markers.length&&(b.loop?e-=b.markers.length:e=-1)):(e-=1,0>e&&(b.loop?e+=b.markers.length:e=-1)),b.current=b.markers[e],d}}function e(a,b){return cornerstoneMath.point.distance(a.handles.end,b)<5}function f(a,d){var f=c.getToolState(a.currentTarget,s);if(void 0!==f){var g=d.canvasContext.canvas.getContext("2d");g.setTransform(1,0,0,1,0,0);for(var h,i=0;i<f.data.length;i++){var j=f.data[i];e(j,c.toolCoordinates.getCoords())?(j.active=!0,h=c.toolColors.getActiveColor()):(j.active=!1,h=c.toolColors.getToolColor());var k={x:j.handles.end.x-4,y:j.handles.end.y+3},l=b.pixelToCanvas(d.element,k);g.font="15px Arial",g.fillStyle=h,g.fillText(j.text,l.x,l.y)}}}function g(b){var e=d(b);e&&(c.addToolState(b.element,s,e),a(b.element).off("CornerstoneToolsMouseMove",j),c.moveHandle(b,e.handles.end,function(){c.anyHandlesOutsideImage(b,e.handles)&&c.removeToolState(b.element,s,e),a(b.element).on("CornerstoneToolsMouseMove",j)}))}function h(a,d){function e(a,c){a.text=c,b.updateImage(d.element)}var f;if(c.isMouseButtonEnabled(d.which,a.data.mouseButtonMask)){var g,h=c.textMarker.getConfiguration(),i=d.startPoints.image,j=c.getToolState(a.currentTarget,s);if(void 0!==j)for(g=0;g<j.data.length;g++){f=j.data[g];var l=k(f,i);if(void 0!==l)return h.changeTextCallback(f,e),a.stopImmediatePropagation(),!1}return!1}}function i(a,b){return c.isMouseButtonEnabled(b.which,a.data.mouseButtonMask)?(g(b),!1):void 0}function j(a,d){if(c.toolCoordinates.setCoords(d),0===d.which){var e=c.getToolState(d.element,s);if(void 0!==e){for(var f=!1,g=0;g<e.data.length;g++){var h=e.data[g];c.handleActivator(h.handles,d.currentPoints.image,d.viewport.scale)===!0&&(f=!0)}f===!0&&b.updateImage(d.element)}}}function k(a,b){for(var c in a.handles){var d=cornerstoneMath.point.distanceSquared(a.handles[c],b);if(25>d)return a.handles[c]}}function l(d,f){function g(){c.anyHandlesOutsideImage(f,h.handles)&&c.removeToolState(f.element,s,h),a(f.element).on("CornerstoneToolsMouseMove",j)}var h;if(c.isMouseButtonEnabled(f.which,d.data.mouseButtonMask)){var i,l=f.startPoints.image,m=c.getToolState(d.currentTarget,s);if(void 0!==m)for(i=0;i<m.data.length;i++){h=m.data[i];var n=k(h,l);if(void 0!==n)return f.event.shiftKey?(c.removeToolState(f.element,s,h),b.updateImage(f.element),d.stopImmediatePropagation(),!1):(a(f.element).off("CornerstoneToolsMouseMove",j),c.moveHandle(f,n,g),d.stopImmediatePropagation(),!1)}if(void 0!==m&&void 0!==e)for(i=0;i<m.data.length;i++)if(h=m.data[i],e(h,l))return a(f.element).off("CornerstoneToolsMouseMove",j),c.moveAllHandles(d,h,m,!0),d.stopImmediatePropagation(),!1}}function m(c){a(c).off("CornerstoneImageRendered",f),a(c).off("CornerstoneToolsMouseMove",j),a(c).off("CornerstoneToolsMouseDown",l),a(c).off("CornerstoneToolsMouseDownActivate",i),a(c).off("CornerstoneToolsMouseDoubleClick",h),b.updateImage(c)}function n(c){a(c).off("CornerstoneImageRendered",f),a(c).off("CornerstoneToolsMouseMove",j),a(c).off("CornerstoneToolsMouseDown",l),a(c).off("CornerstoneToolsMouseDownActivate",i),a(c).off("CornerstoneToolsMouseDoubleClick",h),a(c).on("CornerstoneImageRendered",f),b.updateImage(c)}function o(c,d){var e={mouseButtonMask:d};a(c).off("CornerstoneImageRendered",f),a(c).off("CornerstoneToolsMouseMove",j),a(c).off("CornerstoneToolsMouseDown",l),a(c).off("CornerstoneToolsMouseDownActivate",i),a(c).off("CornerstoneToolsMouseDoubleClick",h),a(c).on("CornerstoneImageRendered",f),a(c).on("CornerstoneToolsMouseMove",e,j),a(c).on("CornerstoneToolsMouseDown",e,l),a(c).on("CornerstoneToolsMouseDownActivate",e,i),a(c).on("CornerstoneToolsMouseDoubleClick",e,h),b.updateImage(c)}function p(c,d){var e={mouseButtonMask:d};a(c).off("CornerstoneImageRendered",f),a(c).off("CornerstoneToolsMouseMove",j),a(c).off("CornerstoneToolsMouseDown",l),a(c).off("CornerstoneToolsMouseDownActivate",i),a(c).off("CornerstoneToolsMouseDoubleClick",h),a(c).on("CornerstoneImageRendered",f),a(c).on("CornerstoneToolsMouseMove",e,j),a(c).on("CornerstoneToolsMouseDown",e,l),a(c).on("CornerstoneToolsMouseDoubleClick",e,h),b.updateImage(c)}function q(){return t}function r(a){t=a}void 0===c&&(c={});var s="textMarker",t={};return c.textMarker={enable:n,disable:m,activate:o,deactivate:p,getConfiguration:q,setConfiguration:r},c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(b,c){a(c.element).off("CornerstoneToolsMouseDrag",g),a(c.element).off("CornerstoneToolsMouseUp",d)}function e(b,e){return c.isMouseButtonEnabled(e.which,b.data.mouseButtonMask)?(a(e.element).on("CornerstoneToolsMouseDrag",g),a(e.element).on("CornerstoneToolsMouseUp",d),!1):void 0}function f(a){var b=a.image.maxPixelValue-a.image.minPixelValue,c=b/1024,d=a.deltaPoints.page.x*c,e=a.deltaPoints.page.y*c;a.viewport.voi.windowWidth+=d,a.viewport.voi.windowCenter+=e}function g(a,d){return c.wwwc.strategy(d),b.setViewport(d.element,d.viewport),!1}function h(a,d){var e=d,f=e.image.maxPixelValue-e.image.minPixelValue,g=f/1024,h=e.deltaPoints.page.x*g,i=e.deltaPoints.page.y*g,j=c.getConfiguration();j.orientation?0===j.orientation?(console.log("normal (default)"),e.viewport.voi.windowWidth+=h,e.viewport.voi.windowCenter+=i):(console.log("swapped"),e.viewport.voi.windowWidth+=i,e.viewport.voi.windowCenter+=h):(console.log("default"),e.viewport.voi.windowWidth+=h,e.viewport.voi.windowCenter+=i),b.setViewport(e.element,e.viewport)}return void 0===c&&(c={}),c.wwwc=c.simpleMouseButtonTool(e),c.wwwc.strategies={"default":f},c.wwwc.strategy=f,c.wwwcTouchDrag=c.touchDragTool(h),c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c,d){"use strict";function e(a){for(var b=65535,c=-32768,d=a.length,e=a,f=0;d>f;f++){var g=e[f];b=Math.min(b,g),c=Math.max(c,g)}return{min:b,max:c}}function f(b,c){a(c.element).off("CornerstoneToolsMouseDrag",j),a(c.element).off("CornerstoneToolsMouseUp",f),p={x:c.currentPoints.image.x,y:c.currentPoints.image.y},g(c)}function g(a){var c=Math.abs(o.x-p.x),d=Math.abs(o.y-p.y),f=Math.min(o.x,p.x),g=Math.min(o.y,p.y),h=b.getPixels(a.element,f,g,c,d),i=e(h),j=b.getViewport(a.element);j.voi.windowWidth=Math.abs(i.max-i.min),j.voi.windowCenter=(i.max-i.min)/2,b.setViewport(a.element,j)}function h(b,c){d.isMouseButtonEnabled(c.which,b.data.mouseButtonMask)&&(a(c.element).on("CornerstoneToolsMouseDrag",j),a(c.element).on("CornerstoneToolsMouseUp",f),i(c))}function i(a){o={x:a.currentPoints.image.x,y:a.currentPoints.image.y}}function j(c,e){p={x:e.currentPoints.image.x,y:e.currentPoints.image.y},b.updateImage(e.element);var f=a(e.element).find("canvas").get(0),g=f.getContext("2d");g.setTransform(1,0,0,1,0,0);var h=d.toolColors.getActiveColor(),i=b.pixelToCanvas(e.element,o),j=b.pixelToCanvas(e.element,p),k=Math.min(i.x,j.x),l=Math.min(i.y,j.y),m=Math.abs(i.x-j.x),n=Math.abs(i.y-j.y);g.beginPath(),g.strokeStyle=h,g.lineWidth=1/e.viewport.scale,g.rect(k,l,m,n),g.stroke()}function k(c){a(c).off("CornerstoneToolsMouseDown",h),b.updateImage(c)}function l(c,d){var e={mouseButtonMask:d};a(c).off("CornerstoneToolsMouseDown",h),a(c).on("CornerstoneToolsMouseDown",e,h),b.updateImage(c)}function m(b){a(b).off("CornerstoneToolsTouchDrag",j),a(b).off("CornerstoneToolsDragStart",i),a(b).off("CornerstoneToolsDragEnd",g)}function n(b){a(b).off("CornerstoneToolsTouchDrag",j),a(b).off("CornerstoneToolsDragStart",i),a(b).off("CornerstoneToolsDragEnd",g),a(b).on("CornerstoneToolsTouchDrag",j),a(b).on("CornerstoneToolsDragStart",i),a(b).on("CornerstoneToolsDragEnd",g)}void 0===d&&(d={});var o,p;return d.wwwcRegion={activate:l,deactivate:k,disable:k},d.wwwcRegionTouch={activate:n,deactivate:m,disable:m},d}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(a,b){if(0!==b.rotation){var c=b.rotation*Math.PI/180,d=Math.cos(c),e=Math.sin(c),f=a.x*d-a.y*e,g=a.x*e+a.y*d;a.x=f,a.y=g}return b.hflip&&(a.x*=-1),b.vflip&&(a.y*=-1),a}function e(a,c,d){var e=1.7,f=Math.log(c.scale)/Math.log(e),g=f+d,h=Math.pow(e,g);c.scale=h,b.setViewport(a,c)}function f(b,c){a(c.element).off("CornerstoneToolsMouseDrag",h),a(c.element).off("CornerstoneToolsMouseUp",f)}function g(b,d){return c.isMouseButtonEnabled(d.which,b.data.mouseButtonMask)?(a(d.element).on("CornerstoneToolsMouseDrag",h),a(d.element).on("CornerstoneToolsMouseUp",f),!1):void 0}function h(a,c){var f=c.deltaPoints.page.y/100;e(c.element,c.viewport,f);var g=b.pageToPixel(c.element,c.startPoints.page.x,c.startPoints.page.y),h={x:c.startPoints.image.x-g.x,y:c.startPoints.image.y-g.y};return h=d(h,c.viewport),c.viewport.translation.x-=h.x,c.viewport.translation.y-=h.y,b.setViewport(c.element,c.viewport),!1}function i(a,b){var c=-b.direction/4;e(b.element,b.viewport,c)}function j(a,b){var c=b;e(c.element,c.viewport,c.direction/4)}function k(a,c){var f=c,g=f.deltaPoints.page.y/100;e(f.element,f.viewport,g);var h=b.pageToPixel(f.element,f.startPoints.page.x,f.startPoints.page.y),i={x:f.startPoints.image.x-h.x,y:f.startPoints.image.y-h.y};return i=d(i,f.viewport),f.viewport.translation.x-=i.x,f.viewport.translation.y-=i.y,b.setViewport(f.element,f.viewport),!1}return void 0===c&&(c={}),c.zoom=c.simpleMouseButtonTool(g),c.zoomWheel=c.mouseWheelTool(i),c.zoomTouchPinch=c.touchPinchTool(j),c.zoomTouchDrag=c.touchDragTool(k),c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c,d){"use strict";function e(b){a(b.element).trigger("CornerstoneToolsDragStartActive",b)}function f(f){f.gesture.preventDefault(),f.gesture.stopPropagation();var g,h=f.currentTarget;switch(f.type){case"transform":var n=m-f.gesture.scale;m=f.gesture.scale;var o={event:f,viewport:b.getViewport(h),image:b.getEnabledElement(h).image,element:h,direction:0>n?1:-1};g=jQuery.Event("CornerstoneToolsTouchPinch",o),a(o.element).trigger(g,o);break;case"touch":if(i={page:c.point.pageToPoint(f.gesture.touches[0]),image:b.pageToPixel(h,f.gesture.touches[0].pageX,f.gesture.touches[0].pageY),client:{x:f.gesture.center.clientX,y:f.gesture.center.clientY}},k={event:f,viewport:b.getViewport(h),image:b.getEnabledElement(h).image,element:h,startPoints:i,lastPoints:j,currentPoints:i,deltaPoints:{x:0,y:0}},g=jQuery.Event("CornerstoneToolsDragStart",k),a(k.element).trigger(g,k),j=d.copyPoints(i),g.isImmediatePropagationStopped()===!1&&e(k)===!0)return d.pauseEvent(f);break;case"drag":p={page:c.point.pageToPoint(f.gesture.touches[0]),image:b.pageToPixel(h,f.gesture.touches[0].pageX,f.gesture.touches[0].pageY),client:{x:f.gesture.center.clientX,y:f.gesture.center.clientY}},q={page:c.point.subtract(p.page,j.page),image:c.point.subtract(p.image,j.image)},l={viewport:b.getViewport(h),image:b.getEnabledElement(h).image,element:h,startPoints:i,lastPoints:j,currentPoints:p,deltaPoints:q},a(k.element).trigger("CornerstoneToolsTouchDrag",l),j=d.copyPoints(p);break;case"dragend":var p={page:c.point.pageToPoint(f.gesture.touches[0]),image:b.pageToPixel(h,f.gesture.touches[0].pageX,f.gesture.touches[0].pageY),client:{x:f.gesture.center.clientX,y:f.gesture.center.clientY}},q={page:c.point.subtract(p.page,j.page),image:c.point.subtract(p.image,j.image)};return l={event:f,viewport:b.getViewport(h),image:b.getEnabledElement(h).image,element:h,startPoints:i,lastPoints:j,currentPoints:p,deltaPoints:q},g=jQuery.Event("CornerstoneToolsDragEnd",l),a(k.element).trigger(g,l),d.pauseEvent(f)}}function g(b){var c={transform_always_block:!0,transform_min_scale:.01,drag_block_horizontal:!0,drag_block_vertical:!0,drag_min_distance:0};a(b).hammer(c).on("touch drag transform dragstart dragend",f)}function h(b){a(b).hammer().off("touch drag transform dragstart dragend",f)}void 0===d&&(d={});var i,j,k,l,m=1;return d.touchInput={enable:g,disable:h},d}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(a,b,c,d){"use strict";function e(a,b){var d=a.image,e={left:0,top:0,width:d.width,height:d.height},f=!1;for(var g in b){var h=b[g];c.point.insideRect(h,e)===!1&&(f=!0)}return f}return void 0===d&&(d={}),d.anyHandlesOutsideImage=e,d}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(a,b,c,d,f){a.strokeStyle=d;var g=e/b.viewport.scale;for(var h in c){var i=c[h];(i.active||i.highlight)&&(a.beginPath(),a.lineWidth=i.active?2/b.viewport.scale:.5/b.viewport.scale,a.arc(i.x,i.y,g,0,2*Math.PI),f&&(a.fillStyle=f,a.fill()),a.stroke())}}void 0===c&&(c={});var e=6;return c.drawHandles=d,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c,d){"use strict";function e(a,b,d){var e=h/d;for(var f in a){var g=a[f],i=c.point.distance(b,g);if(e>=i)return g}return void 0}function f(a){for(var b in a){var c=a[b];if(c.active===!0)return c}return void 0}function g(a,b,c){var d=f(a),g=e(a,b,c);return d!==g?(void 0!==g&&(g.active=!0),void 0!==d&&(d.active=!1),!0):!1}void 0===d&&(d={});var h=6;return d.handleActivator=g,d}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(c,d,e,f){function g(a,c){d.x=c.currentPoints.image.x,d.y=c.currentPoints.image.y,f&&(d.x<0&&(d.x=0),d.x>c.image.width&&(d.x=c.image.width),d.y<0&&(d.y=0),d.y>c.image.height&&(d.y=c.image.height)),b.updateImage(i)}function h(){d.eactive=!1,a(i).off("CornerstoneToolsMouseDrag",g),a(i).off("CornerstoneToolsMouseUp",h),b.updateImage(i),e()}var i=c.element;a(i).on("CornerstoneToolsMouseDrag",g),a(i).on("CornerstoneToolsMouseUp",h)}return void 0===c&&(c={}),c.moveHandle=d,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(c,d,e){function f(a,c){var e=c;d.x=e.currentPoints.image.x,d.y=e.currentPoints.image.y,b.updateImage(h)}function g(){d.eactive=!1,a(h).off("CornerstoneToolsTouchDrag",f),a(h).off("CornerstoneToolsDragEnd",g),b.updateImage(h),e()}var h=c.element;a(h).on("CornerstoneToolsTouchDrag",f),a(h).on("CornerstoneToolsDragEnd",g)}return void 0===c&&(c={}),c.touchmoveHandle=d,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c,d){"use strict";function e(d,e,f,g,h){function i(a,c){for(var d in e.handles){var f=e.handles[d];f.x+=c.deltaPoints.image.x,f.y+=c.deltaPoints.image.y,h&&(f.x<0&&(f.x=0),f.x>c.image.width&&(f.x=c.image.width),f.y<0&&(f.y=0),f.y>c.image.height&&(f.y=c.image.height))}return b.updateImage(l),!1}function j(d,h){if(e.moving=!1,a(l).off("CornerstoneToolsMouseDrag",i),a(l).off("CornerstoneToolsMouseUp",j),g===!0){var k=h.image,m=!1,n={top:0,left:0,width:k.width,height:k.height};for(var o in e.handles){var p=e.handles[o];c.point.insideRect(p,n)===!1&&(m=!0)}if(m){for(var q=-1,r=0;r<f.data.length;r++)f.data[r]===e&&(q=r);-1!==q&&f.data.splice(q,1)}}b.updateImage(l)}var k=d,l=k.element;return a(l).on("CornerstoneToolsMouseDrag",i),a(l).on("CornerstoneToolsMouseUp",j),!0}return void 0===d&&(d={}),d.moveAllHandles=e,d}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(a,b,c,d){"use strict";function e(d,e,f,g){function h(a,c){var d=c;for(var f in e.handles){var g=e.handles[f];g.x+=d.deltaPoints.image.x,g.y+=d.deltaPoints.image.y}return b.updateImage(k),!1}function i(d,j){e.moving=!1;var l=j;if(a(k).off("CornerstoneToolsTouchDrag",h),a(k).off("CornerstoneToolsDragEnd",i),g===!0){var m=l.image,n=!1,o={top:0,left:0,width:m.width,height:m.height};for(var p in e.handles){var q=e.handles[p];c.point.insideRect(q,o)===!1&&(n=!0)}if(n){for(var r=-1,s=0;s<f.data.length;s++)f.data[s]===e&&(r=s);-1!==r&&f.data.splice(r,1)}}b.updateImage(k)}var j=d,k=j.element;return a(k).on("CornerstoneToolsTouchDrag",h),a(k).on("CornerstoneToolsDragEnd",i),!0}return void 0===d&&(d={}),d.touchmoveAllHandles=e,d}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(){var b=this;b.samples=[],this.set=function(c){b.samples=c,a(b).trigger("CornerstoneLineSampleUpdated")}}return void 0===c&&(c={}),c.LineSampleMeasurement=d,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(){var b=this;b.measurements=[],this.add=function(c){var d=b.measurements.push(c),e={index:d,measurement:c};a(b).trigger("CornerstoneMeasurementAdded",e)},this.remove=function(c){var d=b.measurements[c];b.measurements.splice(c,1);var e={index:c,measurement:d};a(b).trigger("CornerstoneMeasurementRemoved",e)}}return void 0===c&&(c={}),c.MeasurementManager=new d,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(a){g.push(a)}function e(a){var b=g.indexOf(a);-1!==b&&g.splice(b,1)}function f(b,c){var d;return a.each(g,function(a,e){return d=e(b,c),void 0!==d?!0:void 0}),d}void 0===c&&(c={});var g=[];return c.metaData={addProvider:d,removeProvider:e,get:f},c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(a){for(var b="",c=a.y<0?"R":"L",d=a.y<0?"A":"P",e=a.z<0?"F":"H",f=new cornerstoneMath.Vector3(Math.abs(a.x),Math.abs(a.y),Math.abs(a.z)),g=0;3>g;g++)if(f.x>1e-4&&f.x>f.y&&f.x>f.z)b+=c,f.x=0;else if(f.y>1e-4&&f.y>f.x&&f.y>f.z)b+=d,f.y=0;else{if(!(f.z>1e-4&&f.z>f.x&&f.z>f.y))break;b+=e,f.z=0}return b}return void 0===c&&(c={}),void 0===c.orientation&&(c.orientation={}),c.orientation.getOrientationString=d,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(a){var b=a.replace("H","f");return b=b.replace("F","h"),b=b.replace("R","l"),b=b.replace("L","r"),b=b.replace("A","p"),b=b.replace("P","a"),b=b.toUpperCase()}return void 0===c&&(c={}),void 0===c.orientation&&(c.orientation={}),c.orientation.invertOrientationString=d,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(a,b){var d=b.imagePositionPatient,e=c.projectPatientPointToImagePlane(d,a),f=c.imagePointToPatientPoint({x:b.columns,y:b.rows},b),g=c.projectPatientPointToImagePlane(f,a),h={start:{x:e.x,y:e.y},end:{x:g.x,y:g.y}};return h}return void 0===c&&(c={}),void 0===c.referenceLines&&(c.referenceLines={}),c.referenceLines.calculateReferenceLine=d,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";
function d(d,e){var f=c.getToolState(d.currentTarget,g);if(void 0!==f){var h=f.data[0].synchronizationContext,i=h.getSourceElements(),j=f.data[0].renderer,k=e.canvasContext.canvas.getContext("2d");b.setToPixelCoordinateSystem(e.enabledElement,k),a.each(i,function(a,b){b!==d.currentTarget&&j(k,e,d.currentTarget,b)})}}function e(e,f,h){h=h||c.referenceLines.renderActiveReferenceLine,c.addToolState(e,g,{synchronizationContext:f,renderer:h}),a(e).on("CornerstoneImageRendered",d),b.updateImage(e)}function f(c){a(c).off("CornerstoneImageRendered",d),b.updateImage(c)}void 0===c&&(c={}),void 0===c.referenceLines&&(c.referenceLines={});var g="referenceLines";return c.referenceLines.tool={enable:e,disable:f},c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(a,d,e,f){var g=b.getEnabledElement(e).image,h=b.getEnabledElement(f).image;if(void 0!==g&&void 0!==h){var i=c.metaData.get("imagePlane",g.imageId),j=c.metaData.get("imagePlane",h.imageId);if(i.frameOfReferenceUID==j.frameOfReferenceUID){var k=i.rowCosines.clone().cross(i.columnCosines),l=j.rowCosines.clone().cross(j.columnCosines),m=k.angleTo(l);if(m=Math.abs(m),!(.5>m)){var n=c.referenceLines.calculateReferenceLine(i,j),o=c.toolColors.getActiveColor();a.beginPath(),a.strokeStyle=o,a.lineWidth=1/d.viewport.scale,a.moveTo(n.start.x,n.start.y),a.lineTo(n.end.x,n.end.y),a.stroke()}}}}return void 0===c&&(c={}),void 0===c.referenceLines&&(c.referenceLines={}),c.referenceLines.renderActiveReferenceLine=d,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(a,d){if(void 0===a)throw"playClip: element must not be undefined";void 0===d&&(d=30);var e=c.getToolState(a,"stack");if(void 0!==e&&void 0!==e.data&&0!==e.data.length){var g,h=e.data[0],i=c.getToolState(a,f);void 0===i||0===i.data.length?(g={intervalId:void 0,framesPerSecond:d,lastFrameTimeStamp:void 0,frameRate:0},c.addToolState(a,f,g)):(g=i.data[0],g.framesPerSecond=d),void 0===g.intervalId&&(g.intervalId=setInterval(function(){var c=h.currentImageIdIndex;if(g.framesPerSecond>0?c++:c--,c>=h.imageIds.length&&(c=0),0>c&&(c=h.imageIds.length-1),c!==h.currentImageIdIndex){var d=b.getViewport(a);b.loadAndCacheImage(h.imageIds[c]).then(function(e){h.currentImageIdIndex=c,b.displayImage(a,e,d)})}},1e3/Math.abs(g.framesPerSecond)))}}function e(a){var b,d=c.getToolState(a,f);void 0!==d&&0!==d.data.length&&(b=d.data[0],clearInterval(b.intervalId),b.intervalId=void 0)}void 0===c&&(c={});var f="playClip";return c.playClip=d,c.stopClip=e,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(a,b){clearTimeout(k),k=setTimeout(function(){var a=b.element,d=c.getToolState(a,"stack");if(void 0!==d&&void 0!==d.data&&0!==d.data.length){var e=c.getToolState(a,l);if(void 0!==e){var g=e.data[0];g.indicesToRequest.length>0&&!g.enabled&&(g.enabled=!0,f(a))}}},50)}function e(a,b){for(var c=[],d=b-a+1;d--;)c[d]=b--;return c}function f(d){function g(a){var b=n.indicesToRequest.indexOf(a);n.indicesToRequest.splice(b,1)}function h(a){throw"stackPrefetch: image not retrieved: "+a}var i=c.getToolState(d,"stack");if(void 0!==i&&void 0!==i.data&&0!==i.data.length){var j=i.data[0],k=j.currentImageIdIndex,m=c.getToolState(d,l);if(void 0!==m){var n=m.data[0];if(0===n.indicesToRequest.length&&(n.enabled=!1),n.enabled!==!1){var o=c.stackPrefetch.getConfiguration(),p=j.imageIds.length,q=n.lastImageIdIndexFetched;q||(q=k);var r=q+o.maxSimultaneousRequests;r>p&&(r=p-1);var s=e(q,r);n.lastImageIdIndexFetched=r+1;var t,u=[];if(0===s.length)return void(n.enabled=!1);s.forEach(function(a){var c=j.imageIds[a];if(n.enabled){var d=b.imageCache.getImagePromise(c);if(void 0===d){var e=b.loadAndCacheImage(c);e.done(function(){g(a);var c=b.imageCache.getCacheInfo();t&&c.cacheSizeInBytes===t.cacheSizeInBytes&&(n.enabled=!1),t=c}),e.fail(function(){h(c)}),u.push(e)}}}),a.when.apply(a,u).done(function(){n.indicesToRequest.length>0&&n.enabled&&setTimeout(f(d),1)}),a.when.apply(a,u).fail(function(){throw"stackPrefetch: batch failed for element: "+d.id})}}}}function g(b){var g=c.stackPrefetch.getConfiguration(),h=c.getToolState(b,l);h=[];var i=c.getToolState(b,"stack");if(void 0!==i&&void 0!==i.data&&0!==i.data.length){var j=i.data[0];(void 0===g||void 0===g.maxSimultaneousRequests)&&(g={maxSimultaneousRequests:Math.max(Math.ceil(j.imageIds.length/5),m)}),c.stackPrefetch.setConfiguration(g),h={indicesToRequest:e(0,j.imageIds.length-1),enabled:!0},c.addToolState(b,l,h),f(b),a(b).off("CornerstoneNewImage",d),a(b).on("CornerstoneNewImage",d)}}function h(b){a(b).off("CornerstoneNewImage",d);var e=c.getToolState(b,l);e&&(e.data[0].enabled=!1)}function i(){return n}function j(a){n=a}void 0===c&&(c={});var k,l="stackPrefetch",m=11,n={};return c.stackPrefetch={enable:g,disable:h,getConfiguration:i,setConfiguration:j},c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(a,d){var e=c.getToolState(a,"stack");if(void 0!==e&&void 0!==e.data&&0!==e.data.length){var f=e.data[0],g=f.currentImageIdIndex+d;if(g=Math.min(f.imageIds.length-1,g),g=Math.max(0,g),g!==f.currentImageIdIndex){var h=b.getViewport(a);b.loadAndCacheImage(f.imageIds[g]).then(function(c){f=e.data[0],f.newImageIdIndex!==g&&(f.currentImageIdIndex=g,b.displayImage(a,c,h))})}}}function e(b,c){a(c.element).off("CornerstoneToolsMouseDrag",g),a(c.element).off("CornerstoneToolsMouseUp",e)}function f(b,d){if(c.isMouseButtonEnabled(d.which,b.data.mouseButtonMask)){var f={deltaY:0,options:b.data.options};return a(d.element).on("CornerstoneToolsMouseDrag",f,g),a(d.element).on("CornerstoneToolsMouseUp",e),b.stopImmediatePropagation(),!1}}function g(d,e){d.data.deltaY+=e.deltaPoints.page.y;var f=c.getToolState(e.element,"stack");if(void 0!==f&&void 0!==f.data&&0!==f.data.length){var g=f.data[0],h=a(e.element).height()/g.imageIds.length;if(void 0!==d.data.options&&void 0!==d.data.options.stackScrollSpeed&&(h=d.data.options.stackScrollSpeed),d.data.deltaY>=h||d.data.deltaY<=-h){var i=d.data.deltaY/h,j=d.data.deltaY%h,k=Math.round(i);d.data.deltaY=j;var l=g.currentImageIdIndex+k;if(l=Math.min(g.imageIds.length-1,l),l=Math.max(0,l),l!==g.currentImageIdIndex){g.currentImageIdIndex=l;var m=b.getViewport(e.element);b.loadAndCacheImage(g.imageIds[l]).then(function(a){var c=f.data[0];c.currentImageIdIndex===l&&b.displayImage(e.element,a,m)})}}return!1}}function h(a,b){var c=-b.direction;d(b.element,c)}function i(a){var d=a.originalEvent.detail,e={deltaY:0};e.deltaY+=d.deltaPoints.page.y;var f=c.getToolState(d.element,"stack");if(void 0!==f&&void 0!==f.data&&0!==f.data.length){var g=f.data[0];if(e.deltaY>=3||e.deltaY<=-3){var h=e.deltaY/3,i=e.deltaY%3,j=Math.round(h);e.deltaY=i;var k=g.currentImageIdIndex+j;if(k=Math.min(g.imageIds.length-1,k),k=Math.max(0,k),k!==g.currentImageIdIndex){g.currentImageIdIndex=k;var l=b.getViewport(d.element);b.loadAndCacheImage(g.imageIds[k]).then(function(a){b.displayImage(d.element,a,l)})}}return!1}}void 0===c&&(c={});return c.stackScroll=c.simpleMouseButtonTool(f),c.stackScrollWheel=c.mouseWheelTool(h),c.stackScrollTouchDrag=c.touchDragTool(i),c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(){function a(a,c,d){var f=b.getEnabledElement(a);e.hasOwnProperty(f.image.imageId)===!1&&(e[f.image.imageId]={});var g=e[f.image.imageId];g.hasOwnProperty(c)===!1&&(g[c]={data:[]});var h=g[c];h.data.push(d)}function c(a,c){var d=b.getEnabledElement(a);if(e.hasOwnProperty(d.image.imageId)===!1)return void 0;var f=e[d.image.imageId];if(f.hasOwnProperty(c)===!1)return void 0;var g=f[c];return g}function d(a){var c=b.getEnabledElement(a);return e.hasOwnProperty(c.image.imageId)===!1?void 0:void delete e[c.image.imageId]}var e={},f={get:c,add:a,clear:d};return f}void 0===c&&(c={});var e=d();return c.newImageIdSpecificToolStateManager=d,c.globalImageIdSpecificToolStateManager=e,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(a,c){function d(d,e,g){if(!(a.indexOf(e)>=0))return c.add(d,e,g);b.getEnabledElement(d);f.hasOwnProperty(e)===!1&&(f[e]={data:[]});var h=f[e];h.data.push(g)}function e(b,d){if(a.indexOf(d)>=0){f.hasOwnProperty(d)===!1&&(f[d]={data:[]});var e=f[d];return e}return c.get(b,d)}var f={},g={get:e,add:d};return g}function e(a){var b=c.getElementToolStateManager(a);void 0===b&&(b=c.globalImageIdSpecificToolStateManager);var d=["stack","stackPrefetch","stackScroll","playClip","volume","slab","referenceLines","crosshairs"],e=c.newStackSpecificToolStateManager(d,b);f.push(e),c.setElementToolStateManager(a,e)}void 0===c&&(c={});var f=[];return c.newStackSpecificToolStateManager=d,c.addStackStateManager=e,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(a,c){function d(d,e,g){if(!(a.indexOf(e)>=0))return c.add(d,e,g);b.getEnabledElement(d);f.hasOwnProperty(e)===!1&&(f[e]={data:[]});var h=f[e];h.data.push(g)}function e(b,d){if(a.indexOf(d)>=0){f.hasOwnProperty(d)===!1&&(f[d]={data:[]});var e=f[d];return e}return c.get(b,d)}var f={},g={get:e,add:d};return g}function e(a,b){b=b||["timeSeries"];var d=c.getElementToolStateManager(a);void 0===d&&(d=c.globalImageIdSpecificToolStateManager);var e=c.newTimeSeriesSpecificToolStateManager(b,d);f.push(e),c.setElementToolStateManager(a,e)}void 0===c&&(c={});var f=[];return c.newTimeSeriesSpecificToolStateManager=d,c.addTimeSeriesStateManager=e,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(){function a(a){i=a}function b(){return i}function c(a){g=a}function d(){return g}function e(a){h=a}function f(){return h}var g="white",h="greenyellow",i="transparent",j={setFillColor:a,getFillColor:b,setToolColor:c,getToolColor:d,setActiveColor:e,getActiveColor:f};return j}return void 0===c&&(c={}),c.toolColors=d(),c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(){function a(a){c=a.currentPoints.image}function b(){return c}var c="",d={setCoords:a,getCoords:b};return d}return void 0===c&&(c={}),c.toolCoordinates=d(),c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(a){var d=b.getEnabledElement(a);return void 0===d.toolStateManager&&(d.toolStateManager=c.globalImageIdSpecificToolStateManager),d.toolStateManager}function e(a,b,c){var e=d(a);e.add(a,b,c)}function f(a,b){var c=d(a);return c.get(a,b)}function g(a,b,c){for(var e=d(a),f=e.get(a,b),g=-1,h=0;h<f.data.length;h++)f.data[h]===c&&(g=h);-1!==g&&f.data.splice(g,1)}function h(a,b){var c=d(a),e=c.get(a,b);void 0!==e&&(e.data=[])}function i(a,c){var d=b.getEnabledElement(a);d.toolStateManager=c}return void 0===c&&(c={}),c.addToolState=e,c.getToolState=f,c.removeToolState=g,c.clearToolState=h,c.setElementToolStateManager=i,c.getElementToolStateManager=d,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(){function a(a){e=a}function b(){return e}function c(a){activeWidth=a}function d(){return activeWidth}var e=1,f={setToolWidth:a,getToolWidth:b,setActiveWidth:c,getActiveWidth:d};return f}return void 0===c&&(c={}),c.toolStyle=d(),c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(a,c,d){if(d!==c){var e=b.getViewport(c),f=b.getViewport(d);(f.scale!==e.scale||f.translation.x!==e.translation.x||f.translation.y!==e.translation.y)&&(f.scale=e.scale,f.translation.x=e.translation.x,f.translation.y=e.translation.y,a.setViewport(d,f))}}return void 0===c&&(c={}),c.panZoomSynchronizer=d,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(a,d,e){if(e!==d){var f=c.getToolState(d,"stack"),g=f.data[0],h=c.getToolState(e,"stack"),i=h.data[0],j=g.currentImageIdIndex;j=Math.min(Math.max(j,0),i.imageIds.length-1),j!==i.currentImageIdIndex&&b.loadAndCacheImage(i.imageIds[j]).then(function(c){var d=b.getViewport(e);i.currentImageIdIndex=j,a.displayImage(e,c,d)})}}return void 0===c&&(c={}),c.stackImageIndexSynchronizer=d,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(d,e,f){if(f!==e){var g=b.getEnabledElement(e).image,h=c.metaData.get("imagePlane",g.imageId),i=h.imagePositionPatient,j=c.getToolState(f,"stack"),k=j.data[0],l=Number.MAX_VALUE,m=-1;a.each(k.imageIds,function(a,b){var d=c.metaData.get("imagePlane",b),e=d.imagePositionPatient,f=e.distanceToSquared(i);l>f&&(l=f,m=a)}),m!==k.currentImageIdIndex&&-1!==m&&b.loadAndCacheImage(k.imageIds[m]).then(function(a){var c=b.getViewport(f);k.currentImageIdIndex=m,d.displayImage(f,a,c)})}}return void 0===c&&(c={}),c.stackImagePositionSynchronizer=d,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(c,d){function e(b){j=!0,a.each(i,function(a,c){d(g,b,c)}),j=!1}function f(a){j!==!0&&e(a.currentTarget)}var g=this,h=[],i=[],j=!1;this.addSource=function(b){var d=h.indexOf(b);-1===d&&(h.push(b),a(b).on(c,f),e(b))},this.addTarget=function(a){var b=i.indexOf(a);-1===b&&(i.push(a),d(g,a,a))},this.add=function(a){g.addSource(a),g.addTarget(a)},this.removeSource=function(b){var d=h.indexOf(b);-1!==d&&(h.splice(d,1),a(b).off(c,f),e(b))},this.removeTarget=function(a){var b=i.indexOf(a);-1!==b&&(i.splice(b,1),d(g,a,a))},this.remove=function(a){g.removeTarget(a),g.removeSource(a)},this.getSourceElements=function(){return h},this.displayImage=function(a,c,d){j=!0,b.displayImage(a,c,d),j=!1},this.setViewport=function(a,c){j=!0,b.setViewport(a,c),j=!1}}return void 0===c&&(c={}),c.Synchronizer=d,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(a,c,d){d!==c&&b.updateImage(d)}return void 0===c&&(c={}),c.updateImageSynchronizer=d,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(a,c,d){if(d!==c){var e=b.getViewport(c),f=b.getViewport(d);(f.voi.windowWidth!==e.voi.windowWidth||f.voi.windowCenter!==e.voi.windowCenter||f.invert!==e.invert)&&(f.voi.windowWidth=e.voi.windowWidth,f.voi.windowCenter=e.voi.windowCenter,f.invert=e.invert,a.setViewport(d,f))}}return void 0===c&&(c={}),c.wwwcSynchronizer=d,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(a){var c=[];a.timeSeries.stacks.forEach(function(d){b.loadAndCacheImage(d.imageIds[a.imageIdIndex]).then(function(b){var d=Math.round(a.handles.end.x)+Math.round(a.handles.end.y)*b.width,e=b.getPixelData()[d];c.push(e)})}),a.lineSample.set(c)}function e(a){var b=c.getToolState(a.element,"timeSeries");if(void 0!==b&&void 0!==b.data&&0!==b.data.length){var e=b.data[0],f={timeSeries:e,lineSample:new c.LineSampleMeasurement,imageIdIndex:e.stacks[e.currentStackIndex].currentImageIdIndex,visible:!0,handles:{end:{x:a.currentPoints.image.x,y:a.currentPoints.image.y,highlight:!0,active:!0}}};return d(f),c.MeasurementManager.add(f),f}}function f(a,d){var e=c.getToolState(a.currentTarget,g);if(void 0!==e){var f=d.canvasContext.canvas.getContext("2d");b.setToPixelCoordinateSystem(d.enabledElement,f);for(var h="white",i=0;i<e.data.length;i++){f.save();var j=e.data[i];f.beginPath(),c.drawHandles(f,d,j.handles,h),f.stroke();var k=c.setContextToDisplayFontSize(d.enabledElement,d.canvasContext,15);f.font=""+k.fontSize+"px Arial";var l=Math.round(j.handles.end.x),m=Math.round(j.handles.end.y);n=j.handles.end.x+3,o=j.handles.end.y-3;var n=n/k.fontScale,o=o/k.fontScale;f.fillStyle="white",f.fillText(""+l+","+m,n,o),f.restore()}}}void 0===c&&(c={});var g="probe4D";return c.probeTool4D=c.mouseButtonTool({createNewMeasurement:e,onImageRendered:f,toolType:g}),c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(a,d,e){var f=c.getToolState(a,"timeSeries");if(void 0!==f&&void 0!==f.data&&0!==f.data.length){var g=f.data[0],h=g.stacks[g.currentStackIndex],i=h.currentImageIdIndex,j=g.currentStackIndex+d;if(e?(j>=g.stacks.length&&(j=0),0>j&&(j=g.stacks.length-1)):(j=Math.min(g.stacks.length-1,j),j=Math.max(0,j)),j!==g.currentStackIndex){var k=b.getViewport(a),l=g.stacks[j];b.loadAndCacheImage(l.imageIds[i]).then(function(c){g.currentImageIdIndex!==i&&(l.currentImageIdIndex=i,g.currentStackIndex=j,b.displayImage(a,c,k))})}}}void 0===c&&(c={});return c.incrementTimePoint=d,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(a,b){if(void 0===a)throw"playClip: element must not be undefined";void 0===b&&(b=30);var d=c.getToolState(a,"timeSeries");if(void 0!==d&&void 0!==d.data&&0!==d.data.length){var e,g=d.data[0],h=c.getToolState(a,f);void 0===h||0===h.data.length?(e={intervalId:void 0,framesPerSecond:b,lastFrameTimeStamp:void 0,frameRate:0},c.addToolState(a,f,e)):(e=h.data[0],e.framesPerSecond=b),void 0===e.intervalId&&(e.intervalId=setInterval(function(){g.stacks[g.currentStackIndex].currentImageIdIndex,g.currentStackIndex;e.framesPerSecond>0?c.incrementTimePoint(a,1,!0):c.incrementTimePoint(a,-1,!0)},1e3/Math.abs(e.framesPerSecond)))}}function e(a){var b,d=c.getToolState(a,f);void 0!==d&&0!==d.data.length&&(b=d.data[0],clearInterval(b.intervalId),b.intervalId=void 0)}void 0===c&&(c={});var f="timeSeriesPlayer";return c.timeSeriesPlayer={start:d,stop:e},c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(b,c){a(c.element).off("CornerstoneToolsMouseDrag",f),a(c.element).off("CornerstoneToolsMouseUp",d)}function e(b,e){if(c.isMouseButtonEnabled(e.which,b.data.mouseButtonMask)){var g={deltaY:0,options:b.data.options};return a(e.element).on("CornerstoneToolsMouseDrag",g,f),a(e.element).on("CornerstoneToolsMouseUp",d),b.stopImmediatePropagation(),!1}}function f(b,d){b.data.deltaY+=d.deltaPoints.page.y;var e=c.getToolState(d.element,"timeSeries");if(void 0!==e&&void 0!==e.data&&0!==e.data.length){var f=e.data[0],g=a(d.element).height()/f.stacks.length;if(void 0!==b.data.options&&void 0!==b.data.options.timeSeriesScrollSpeed&&(g=b.data.options.timeSeriesScrollSpeed),b.data.deltaY>=g||b.data.deltaY<=-g){var h=Math.round(b.data.deltaY/g),i=b.data.deltaY%g;c.incrementTimePoint(d.element,h),b.data.deltaY=i}return!1}}function g(a,b){var d=-b.direction;c.incrementTimePoint(b.element,d)}function h(a){var b=a.originalEvent.detail,d={deltaY:0};d.deltaY+=b.deltaPoints.page.y;var e=c.getToolState(b.element,"stack");if(void 0!==e&&void 0!==e.data&&0!==e.data.length){if(d.deltaY>=3||d.deltaY<=-3){var f=d.deltaY/3,g=d.deltaY%3;c.setTimePoint(d.element,f),d.deltaY=g}return!1}}void 0===c&&(c={});return c.timeSeriesScroll=c.simpleMouseButtonTool(e),c.timeSeriesScrollWheel=c.mouseWheelTool(g),c.timeSeriesScrollTouchDrag=c.touchDragTool(h),c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(a,b){var c=Math.pow(10,b);return Math.round(a*c)/c}return void 0===c&&(c={}),c.roundToDecimal=d,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c,d){"use strict";function e(a){var b=c.point.copy(a.page),d=c.point.copy(a.image);return{page:b,image:d}}return void 0===d&&(d={}),d.copyPoints=e,d}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(a){"use strict";function b(a,b,c,d,e){var f=.5522848,g=d/2*f,h=e/2*f,i=b+d,j=c+e,k=b+d/2,l=c+e/2;a.beginPath(),a.moveTo(b,l),a.bezierCurveTo(b,l-h,k-g,c,k,c),a.bezierCurveTo(k+g,c,i,l-h,i,l),a.bezierCurveTo(i,l+h,k+g,j,k,j),a.bezierCurveTo(k-g,j,b,l+h,b,l),a.closePath(),a.stroke()}return void 0===a&&(a={}),a.drawEllipse=b,a}(cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(a,b){var c=1<<a-1;return 0!==(b&c)}return void 0===c&&(c={}),c.isMouseButtonEnabled=d,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(a){return a.stopPropagation&&a.stopPropagation(),a.preventDefault&&a.preventDefault(),a.cancelBubble=!0,a.returnValue=!1,!1}return void 0===c&&(c={}),c.pauseEvent=d,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){"use strict";function d(a,b){var c=a.clone().sub(b.imagePositionPatient),d=b.columnCosines.dot(c)/b.columnPixelSpacing,e=b.rowCosines.dot(c)/b.rowPixelSpacing,f={x:d,y:e};return f}function e(a,b){var c=b.columnCosines.clone().multiplyScalar(a.x);c.multiplyScalar(b.columnPixelSpacing);var d=b.rowCosines.clone().multiplyScalar(a.y);d.multiplyScalar(b.rowPixelSpacing);var e=c.add(d);return e.add(b.imagePositionPatient),e}return void 0===c&&(c={}),void 0===c.referenceLines&&(c.referenceLines={}),c.projectPatientPointToImagePlane=d,c.imagePointToPatientPoint=e,c}($,cornerstone,cornerstoneTools),cornerstone=function(a){"use strict";function b(b,c,d){var e=.1;a.setToPixelCoordinateSystem(b,c,e);var f=d/b.viewport.scale/e,g=d/b.viewport.scale/e;return{fontSize:f,lineHeight:g,fontScale:e}}return void 0===a&&(a={}),cornerstoneTools.setContextToDisplayFontSize=b,a}(cornerstone);